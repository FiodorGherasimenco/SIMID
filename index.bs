<pre class='metadata'>
Title: Secure Interactive Media Interface Definition (SIMID) <br><img alt="IAB Tech Lab" src="images/IABTechLabLogo.jpg" >
Shortname: SIMID
Level: 1
Status: LS
Group: IAB Tech Lab
!License: <p style="fontsize:small">The SIMID Specification from the IAB Tech Lab is licensed a Creative Commons Attribution, Non Commercial, No Derivatives License. To view a copy of this license, visit <a href="creativecommons.org/licenses/by-nc-nd/4.0/legalcode">creativecommons.org/licenses/by-nc-nd/4.0/legalcode</a> or write to Creative Commons, 171 Second Street, Suite 300, San Francisco, CA 94105, USA.</p>
!About the IAB Technology Lab: The IAB Technology Laboratory (Tech Lab) is a non-profit consortium that engages a member community globally to develop foundational technology and standards that enable growth and trust in the digital media ecosystem.. Comprised of digital publishers, ad technology firms, agencies, marketers, and other member companies, IAB Tech Lab focuses on improving the digital advertising supply chain, measurement, and consumer experiences, while promoting responsible use of data. Its work includes the OpenRTB real-time bidding protocol, ads.txt anti- fraud specification, Open Measurement SDK for viewability and verification, VAST video specification, and DigiTrust identity service. Board members include ExtremeReach, Facebook, Google, GroupM, Hearst Digital Media, Index Exchange, Integral Ad Science, LinkedIn, LiveRamp, MediaMath, Microsoft, Oracle Data Cloud, Pandora, PubMatic, Quantcast, Rakuten Marketing, Telaria, The Trade Desk, Verizon Media Group, Xandr, and Yahoo! Japan. Established in 2014, the IAB Tech Lab is headquartered in New York City with staff in San Francisco, Seattle, and London. Learn more at https://www.iabtechlab.com.
URL: https://interactiveadvertisingbureau.github.io/SIMID/
Repository: InteractiveAdvertisingBureau/SIMID
Editor: IAB Tech Lab's Digital Video Technical Working Group, video@iabtechlab.com
Abstract: Establishes a common and secure communication protocol between video players and executable ad units, providing rich ad experiences for viewers.
Markup Shorthands: markdown yes, idl yes, dfn yes, markup yes
</pre>

# Version # {#version-number}
1.0

<style>

	body {
		counter-reset: diagram;
		counter-reset: table-num;
	}

	table.alternatecolor {
		border-collapse: collapse;
		width: 100%;
	}
	
	table.alternatecolor th, td {
		border: solid #CCCCCC;
  		padding: 5px;
		vertical-align: top;
		border-width: 0 1px 0 1px;
    }

	table.alternatecolor th{
		border-color: #000;
		background-color: #000;
		color:#FFFFFF;
	}
	
	table.alternatecolor tr:nth-child(odd) td {
		background-color: #EFEFEF; 
	}
	
	table.alternatecolor tr:nth-child(even) td {
		background-color: #FFF;
	}
	
	table.alternatecolor tr:last-child td, td.last-row {
		border-bottom-width: 1px;
	}
	
	table.two-col-split td:nth-child(3n+0){
		background: #FFF !important;
		border: 0;
	}
	table.two-col-split th:nth-child(3n+0){
		background: #FFF !important;
		border: 0;
	}
	table.two-col-split td:nth-child(3n+2){
		text-align: center;
	}
	table.two-col-split th:nth-child(3n+2){
		text-align: center;
	}
	
	table.two-col-split td:nth-child(3n+2):before{
		content: "\2716";
		color: #008000;
		
	}
	
	table.alternatecolor td.empty {
		display:none;
	}
	
	td[req]:before {
		content: "\2714" !important;
		color: #D20000 !important;
	}

	p[table-header]{
		counter-increment: table-num;
		font-weight: 700;

	}

	p[table-header]:before{
		content: "Table " counter(table-num) ". ";
		font-style: italic;
	}

	ul.footnote {
		list-style-type: none;  
		font-size: 0.9em;
		margin: 0;
	}

	ul.footnote li:before{
		width: 1em !important;
		margin-left: -1em;
		display: inline-block;
	}

	ul.footnote li:nth-child(1):before {
		content:'*';
	}
	ul.footnote li:nth-child(2):before {
		content:'†';
	}
	ul.footnote li:nth-child(3):before {
		content:'‡';
	}
	ul.footnote li:nth-child(4):before {
		content:'§';
	}
	ul.footnote li:nth-child(5):before {
		content:'◊';
	}
	ul.footnote li:nth-child(6):before {
		content:'¶';
	}
	
	ul.values-list{
		margin: 0;
		list-style-type: none;
	}
	
	ul.values-list > li:nth-child(odd){
		background: #FFF;
	}
	
	ul.values-list code{
		margin: 0 1em 0 1em;
	}
	
	ul.values-list li{
		margin: 0;
	}
	
	table.messages-summary td code:before{
		content: "\2023" !important;
		margin-right: 0.5em;
	}
	
	table.messages-summary td:nth-child(1) code:before{
		content: "" !important;
		margin-right: 0;
	}

	table.messages-summary td a{
		font-family: Menlo, Consolas, "DejaVu Sans Mono", Monaco, monospace;
		font-size: 0.9em;
	}
	
	pre.idl{
		margin-bottom: 0 !important;
		border-width: 8px !important;
	}
	
	dl.idl{
		margin-top: 0 !important;
		border-width: 8px !important;
	}
	ul[collapse], ol[collapse]{
		margin: 0;
	}

	p[warning]{
		border-color: rgb(243, 87, 87);
    	background-color: rgb(245, 230, 230);
	}
	
	ul[collapse] li {
		margin-top: 0;
		line-height: 1.5em;
	}
	ol[collapse] li {
		margin-top: 0;
		line-height: 1.5em;
	}
	
	ol[alpha]{
		list-style-type: lower-alpha;
	}

	

	div[diagram]{
		counter-increment: diagram;
		position: relative;
		border: 1px solid silver;
		border-radius: 7px;
		padding: 10px;
		margin: 10px 0 10px 0;
		overflow: hidden;
	}

	div[diagram] p:first-child::before{
		content: "Diagram " counter(diagram) ". ";
		margin-left: 10px;
	}

	div[diagram] > p:first-child{
		font-weight: 600;
		font-style:italic;
		
		padding-left: 28px;
		margin: 0 0 20px 0;
		background-repeat: no-repeat;
		background-size: 1.5em;
		background-position-y: 2px;
		background-image: url('data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+DQo8c3ZnIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2aWV3Qm94PSIwIDAgMzYgMjYiPg0KCTxwYXRoIGZpbGw9IiM1ODU5NWIiIGQ9Ik0yNCwxMGMwLDAuNTUyLTAuNDQ4LDEtMSwxSDEzYy0wLjU1MiwwLTEtMC40NDgtMS0xVjRjMC0wLjU1MiwwLjQ0OC0xLDEtMWgxMGMwLjU1MiwwLDEsMC40NDgsMSwxVjEweiIvPg0KCTxwYXRoIGZpbGw9IiM1ODU5NWIiIGQ9Ik0xMSwyMmMwLDAuNTUyLTAuNDQ4LDEtMSwxSDRjLTAuNTUyLDAtMS0wLjQ0OC0xLTF2LTRjMC0wLjU1MiwwLjQ0OC0xLDEtMWg2YzAuNTUyLDAsMSwwLjQ0OCwxLDFWMjJ6Ii8+DQoJPHBhdGggZmlsbD0iIzU4NTk1YiIgZD0iTTIyLDIyYzAsMC41NTItMC40NDgsMS0xLDFoLTZjLTAuNTUyLDAtMS0wLjQ0OC0xLTF2LTRjMC0wLjU1MiwwLjQ0OC0xLDEtMWg2YzAuNTUyLDAsMSwwLjQ0OCwxLDFWMjJ6Ii8+DQoJPHBhdGggZmlsbD0iIzU4NTk1YiIgZD0iTTMzLDIyYzAsMC41NTItMC40NDgsMS0xLDFoLTZjLTAuNTUyLDAtMS0wLjQ0OC0xLTF2LTRjMC0wLjU1MiwwLjQ0OC0xLDEtMWg2YzAuNTUyLDAsMSwwLjQ0OCwxLDFWMjJ6Ii8+DQoJPHBhdGggZmlsbD0iIzU4NTk1YiIgZD0iTTI5LDEzSDE5VjloLTJ2NEg3Yy0wLjU1MiwwLTEsMC40NDgtMSwxdjZoMnYtNWg5djRoMnYtNGg5djVoMnYtNkMzMCwxMy40NDgsMjkuNTUyLDEzLDI5LDEzeiIvPg0KCTxwYXRoIGZpbGw9IiM1ODU5NWIiIGQ9Ik0zNiwyYzAtMS4xMDQtMC44OTYtMi0yLTJIMkMwLjg5NiwwLDAsMC44OTYsMCwydjIyYzAsMS4xMDQsMC44OTYsMiwyLDJoMzJjMS4xMDQsMCwyLTAuODk2LDItMlYyeiBNMzUsMjQNCgkJYzAsMC41NTItMC40NDgsMS0xLDFIMmMtMC41NTIsMC0xLTAuNDQ4LTEtMVYyYzAtMC41NTIsMC40NDgtMSwxLTFoMzJjMC41NTIsMCwxLDAuNDQ4LDEsMVYyNHoiLz4NCjwvc3ZnPg0K');
	}

  ol[dgrm-details]{
    counter-reset: dgrm-sequence;
    list-style: none;
    border: 0px dotted silver;
    border-radius: 5px;
    padding: 10px 10px 10px 10px;
    background-size: 1.5em;
    background-position: 10px 10px;
    background-repeat: no-repeat;
    background-image-x: url('data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+DQo8c3ZnIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2aWV3Qm94PSIwIDAgMzYgMzYiIHhtbDpzcGFjZT0icHJlc2VydmUiPg0KPHBhdGggZmlsbD0iIzU4NTk1YiIgZD0iTTM2LDMzYzAsMS42NTctMS4zNDMsMy0zLDNIM2MtMS42NTcsMC0zLTEuMzQzLTMtM1YzYzAtMS42NTcsMS4zNDMtMywzLTNoMzBjMS42NTcsMCwzLDEuMzQzLDMsM1YzM3oiLz4NCjxjaXJjbGUgZmlsbD0iI0ZGRkZGRiIgY3g9IjE4IiBjeT0iMTgiIHI9IjE1Ii8+DQo8Y2lyY2xlIGZpbGw9IiM1ODU5NWIiIGN4PSIxOCIgY3k9IjE4IiByPSIxMSIvPg0KPHJlY3QgeD0iMTIiIHk9IjEyIiBmaWxsPSIjRkZGRkZGIiB3aWR0aD0iMyIgaGVpZ2h0PSIzIi8+DQo8cmVjdCB4PSIxNi41IiB5PSIxMiIgZmlsbD0iI0ZGRkZGRiIgd2lkdGg9IjMiIGhlaWdodD0iMyIvPg0KPHJlY3QgeD0iMjEiIHk9IjEyIiBmaWxsPSIjRkZGRkZGIiB3aWR0aD0iMyIgaGVpZ2h0PSIzIi8+DQo8cmVjdCB4PSIxMiIgeT0iMTYuNSIgZmlsbD0iI0ZGRkZGRiIgd2lkdGg9IjMiIGhlaWdodD0iMyIvPg0KPHJlY3QgeD0iMTYuNSIgeT0iMTYuNSIgZmlsbD0iI0ZGRkZGRiIgd2lkdGg9IjMiIGhlaWdodD0iMyIvPg0KPHJlY3QgeD0iMjEiIHk9IjE2LjUiIGZpbGw9IiNGRkZGRkYiIHdpZHRoPSIzIiBoZWlnaHQ9IjMiLz4NCjxyZWN0IHg9IjEyIiB5PSIyMSIgZmlsbD0iI0ZGRkZGRiIgd2lkdGg9IjMiIGhlaWdodD0iMyIvPg0KPHJlY3QgeD0iMTYuNSIgeT0iMjEiIGZpbGw9IiNGRkZGRkYiIHdpZHRoPSIzIiBoZWlnaHQ9IjMiLz4NCjxyZWN0IHg9IjIxIiB5PSIyMSIgZmlsbD0iI0ZGRkZGRiIgd2lkdGg9IjMiIGhlaWdodD0iMyIvPg0KPC9zdmc+DQo=')
  }

 ol[dgrm-details] li::before{
    vertical-align: super;
    font-size: 0.75em;
    margin-right: 0.5em;
    background-color: #5b5b5b;
    color: #FFF;
    padding: 2px 4px;
    border-radius: 3px;
  }

  ol[dgrm-details] > li::before{
    counter-increment: dgrm-sequence;
    content: "" counter(dgrm-sequence) "";
  }
  
  ol[dgrm-details] > li > ol{
    list-style: none;
    counter-reset: dgrm-sequence-level-2;
  }

  ol[dgrm-details] > li > ol > li::before{
    counter-increment: dgrm-sequence-level-2;
    content: "" counter(dgrm-sequence) "." counter(dgrm-sequence-level-2) "";
  }
	span[steps]:before{
		content:"steps ";
	}
	span[steps] b{
		font-size: 0.75em;
		margin-right: 0.5em;
		background-color: #5b5b5b;
		color: #FFF;
		padding: 2px 6px;
		border-radius: 3px;
	}

	[skip-ad]{
		background-color: #5b5b5b;
		color: #FFFFFF;
		border: 1px solid #5b5b5b;
		border-radius: 2px;
		outline: none;
		padding: 4px 6px;
	}

	[skip-ad]::after{
		content: "\25BA""|";
		font-weight: 700;
		letter-spacing: -3px;
		margin-left: 4px;
	}
</style>

# Executive Summary # {#exec-summary}

Secure Interactive Media Interface Definition (SIMID) is a standard for providing rich interactivity in the context of
streaming audio and video ads. While the Video Ad Serving Template (VAST) standard addresses how publishers
discover various metadata assets related to an ad campaign, SIMID addresses
how the publisher’s video player should communicate and interface with a rich
interactive layer and vice versa. As such, one can think of the SIMID creative
as one of the assets listed in a VAST document.

A main tenet of SIMID is the separation of the interactive layer from the media
asset. This clear separation allows publisher players to be in control of their
streams and enables use cases such as server-side ad insertion (SSAI), as well
as live streaming.

SIMID was built with strong security from the ground up, and is designed to be
sandboxed from the media player, providing peace of mind to publishers when
serving ads from third party services. SIMID aims to provide the tools and
controls to allow creatives to offer rich augmented user experiences while
degrading gracefully if certain features are not supported.


<div diagram id="diagram-simid-overlay">
	<p>SIMID ads sandboxing from the publisher player environment</p>
	<img src="images/simid_diagram_1_overlay.png" alt="Normal Creative Initilaizatioin Sequence"/>
</div>

A diagram showing SIMID ads sandboxed from the publisher player environment

SIMID is part of a broader effort to replace the older VPAID standard (more details in <a href="http://bit.ly/videoAdVision">this blog post</a> by the IAB Tech Lab). While
Open Measurement replaces the use case of verification and measurement, SIMID replaces
the use case of interactive streaming media ads, the original intended purpose
of the VPAID standard. SIMID provides a path for VPAID deprecation and allows
the industry to move to more secure and transparent standards. SIMID aims to
gain broad industry adoption by ensuring that the standard is focused on the
primary use case of interactivity.

## SIMID vs. VPAID Comparison ## {#simid-vs-vpaid}

<div diagram id="diagram-simid-api-models">
	<p>VPAID vs. SIMID APIs</p>
	<img src="images/simid_diagram_2_api_models.png" alt="Normal Creative Initilaizatioin Sequence" style="margin-left: -10px;"/>
</div>

<p table-header id="simid-vs-vapid">SIMID vs. VPAID Comparison.</p>
<table class="alternatecolor">
  <tbody>
	<tr>
      <th width="20%">Feature</th>
      <th width="40%">VPAID</th>
      <th width="40%">SIMID</th>
    </tr>
   
    <tr>
      <td>Security</td>
      <td>Creative directly accesses player DOM and shared global JavaScript context.</td>
      <td>Creative is sandboxed into a cross-origin iframe. No player DOM access or shared JavaScript context.</td>
    </tr>
    <tr class="c13">
      <td>Ad media asset management</td>
      <td>Creative manages ad media loading and playback (video).</td>
      <td>Player manages ad media loading and playback (audio or video).</td>
    </tr>
    <tr>
      <td>Pre-caching</td>
      <td>Only the VPAID script can be reliably pre-cached. Video asset cannot be pre-cached.</td>
      <td>Audio or video asset and SIMID creative can both be pre-cached.</td>
    </tr>
    <tr>
      <td>Errors influence on performance or UX</td>
      <td>Fatal script errors from ad creative can result in significant player or publisher site performance and user experience deterioration (due to shared security sandbox).</td>
      <td>Fatal script errors from ad creative do not affect player or publisher site directly. Impact is limited to performance and user experience of the creative, only.</td>
    </tr>
    <tr>
      <td>SSAI feasibility</td>
      <td>SSAI is not possible.</td>
      <td rowspan="1">Interactive creatives can be rendered in SSAI context.</td>
    </tr>
    <tr>
      <td>Latencies</td>
      <td>Publishers are at the mercy of VPAID creative implementation efficiency and uncontrollable internal processes (verification, trading, wrapping, etc.). Each of these behaviors can impose significant latencies.</td>
      <td>Players can pre-load media and creative assets due to maintaining full control over decisioning, loading and displaying of the ad unit. Ad decisioning latency is removed, risks of internal processes are minimized due to separate security sandboxes.</td>
    </tr>
    <tr>
      <td>API</td>
      <td>Both the player and creative must support specific javascript functions. Each component calls functions directly on the other in a shared security sandbox (insecure).</td>
      <td>No functions are directly called on either component by the other. All communication is achieved using standard postMessage API and SIMID messaging protocol across separate security sandboxes.</td>
    </tr>
    <tr>
      <td>Ad blocking</td>
      <td>VPAID can prevent an ad from rendering.</td>
      <td>SIMID is built for interactivity and was not designed for ad blocking. The Open Measurement SDK (OMID) is expected to support this capability in the future.</td>
    </tr>
    <tr>
      <td>Verification services</td>
      <td>Verification features can be fully implemented and executed in shared DOM and global Javascript context.</td>
      <td>SIMID creative cannot access any DOM, elements, or JS context outside of its own security sandbox so is unable to handle any verification use cases. OMID handles the use case for verification allowing SIMID to be focused on interactivity only.</td>
    </tr>
    <tr>
      <td>Creative wrapping</td>
      <td>VPAID ads can load other ads (including other VPAID ads).</td>
      <td>Cannot be executed.</td>
    </tr>
    <tr>
      <td>Audio advertising</td>
      <td>Out of standard scope.</td>
      <td>Enables interactive components serving with audio ads.</td>
    </tr>
    <tr>
      <td>Environment constraints</td>
      <td>Player must be an HTML video element.</td>
      <td>Player can be native or web so long as the SIMID creative has sandboxed DOM access (such as a web view).</td>
    </tr>
    <tr>
      <td>Resource MIME type</td>
      <td>application/javascript</td>
      <td>text/html</td>
    </tr>
  </tbody>
</table>

## Intended Audience ## {#intended-audience}

The SIMID standard is geared toward the digital media advertising community. Anyone who works with digital media advertising products or services can benefit from reading the Introduction sections of this document. The Messaging Protocol, API Reference, and later sections predominantly target software engineers.


# Introduction # {#intro}

Throughout this document, the SIMID interactive component is referred to
as a “SIMID creative” or “creative”.

Compliance with SIMID requires support for all features and behaviors specificied in this document, unless a given feature or behavior is explicitly designated as optional.
Standard RFC language will be used. See <a href="https://tools.ietf.org/html/rfc2119">https://tools.ietf.org/html/rfc2119</a>
for RFC 2119 for enforcement terminology used in this standard.

## SIMID Interactive Creative Nature ## {#simid-interactive-creative-nature}
<div diagram id="diagram-simid-api-models">
	<p>SIMID Assets loading</p>
	<img src="images/simid_diagram_3_assets.png" alt="SIMID Interactive Creative Nature" style="margin-left: -10px;"/>
</div>

A SIMID creative can be included in a VAST document by way of an `<InteractiveCreativeFile>`
element. The text within this element must be a url which returns an HTML document.
When loaded into an iframe by a media player, this HTML document will define the SIMID creative's content, and will direct the web browser or host application to load any additional assets
required by that creative (images, CSS, scripts, etc.).

The `<InteractiveCreativeFile>` element is defined as a child of the `<MediaFiles>` element in VAST 4.0.
For more technical details, see the [[#api-vast]] section.

Example:
```
<MediaFiles>
    <MediaFile>https://example.com/mediafile.mp4</MediaFile>
    <InteractiveCreativeFile type="text/html" apiFramework="SIMID" variableDuration="true">
        <![CDATA[https://adserver.com/ads/creative.html]]>
    </InteractiveCreativeFile>
</MediaFiles>
```

## SIMID Ad Serving Flow ## {#video-ad-flow}

The SIMID ad experience is delivered by a web browser or application concurrently rendering
an ad's streaming audio or video file and its interactive creative file. The media player obtains
urls for both files from a VAST document, loads the files, assembles
them together into a single ad unit, and ensures a cohesive ad experience.

<div diagram id="diagram-simid-api-models">
	<p>SIMID creative loading and presentation process.</p>
	<img src="images/simid_diagram_4_loading.png" alt="SIMID creative loading and presentation process." style="margin-left: -10px;"/>
</div>


## Player and Creative Communication ## {#player-creative-communication}

A media player and a SIMID creative communicate by sending serialized messages back and forth to each other.

Because a SIMID creative is an HTML document that is served from an advertiser’s
web domain, and it is loaded by a media player into an iframe within a web page hosted on a different domain,
loading the creative requires the creation of a cross-origin iframe (also known as an "unfriendly iframe").
Due to browser sandbox security restrictions, javascript communication across this type of iframe can only be achieved via the standard postMessage API.

SIMID API requirements govern message construction conventions as well as the message data structure. See sections [[#msg-proto]], [[#api]] for more information.

## Scope and Limitations ## {#scope}

The use of HTML is only required for the SIMID creative, not the publisher
property hosting that creative. As long as the publisher can load HTML and
communicate with it over the standard postMessage API, it can support
SIMID. In practice, this means that SIMID can be hosted in web page iframes,
mobile app web views, and other platforms. In fact, SIMID can better support mobile use cases than VPAID because a native app or media player directly controls loading and playback of a SIMID ad unit's
media asset (whereas a VPAID ad unit offers no direct access or control of its internal media asset).

Note that certain devices, including TV sets and OTT boxes, limit loading of
external assets, have limited HTML rendering capabilities or are unable to
display html along with audio or video. These devices are unable to support SIMID. Devices that support HTML and Javascript can support SIMID - in both client side as well as server side ad insertion scenarios.


SIMID cannot be used to decide which media to show on the client
pre-impression. This is because the media file must be present alongside
the SIMID creative and delivered via the VAST `MediaFile` node.

SIMID should not be set up to measure viewability.

Any use of the SIMID spec to support something other than interactive or
dynamic content within the ad unit is counter to the intentions of this spec.

# API Reference # {#api}

All SIMID messages are sent via the [[#msg-proto]]

## Reference Table ## {#reference-table}

<table class="alternatecolor">
  <tbody>
    <tr>
      <th width="40%">API</th>
      <th width="30%">resolve</th>
      <th width="30%">reject</th>
    </tr>
    <tr>
      <td>[[#simid-media-durationchange]]</td>
      <td>n/a</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>[[#simid-media-ended]]</td>
      <td>n/a</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>[[#simid-media-error]]</td>
      <td>n/a</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>[[#simid-media-pause]]</td>
      <td>n/a</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>[[#simid-media-play]]</td>
      <td>n/a</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>[[#simid-media-playing]]</td>
      <td>n/a</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>[[#simid-media-seeked]]</td>
      <td>n/a</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>[[#simid-media-seeking]]</td>
      <td>n/a</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>[[#simid-media-stalled]]</td>
      <td>n/a</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>[[#simid-media-timeupdate]]</td>
      <td>n/a</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>[[#simid-media-volumechange]]</td>
      <td>n/a</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>[[#simid-player-adSkipped]]</td>
      <td>[[#simid-player-adSkipped-resolve]]</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>[[#simid-player-adStopped]]</td>
      <td>[[#simid-player-adStopped-resolve]]</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>[[#simid-player-app-backgrounding]]</td>
      <td>[[#simid-player-app-backgrounding-resolve]]</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>[[#simid-player-app-foregrounding]]</td>
      <td>n/a</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>[[#simid-player-fatalError]]</td>
      <td>[[#simid-player-fatalError-resolve]]</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>[[#simid-player-init]]</td>
      <td>[[#simid-player-init-resolve]]</td>
      <td>[[#simid-player-init-reject]]</td>
    </tr>
    <tr>
      <td>[[#simid-player-log]]</td>
      <td>n/a</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>[[#simid-player-resize]]</td>
      <td>n/a</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>[[#simid-player-startCreative]]</td>
      <td>[[#simid-player-startCreative-resolve]]</td>
      <td>[[#simid-player-startCreative-reject]]</td>
    </tr>
    <tr>
      <td>[[#simid-creative-clickThru]]</td>
      <td>n/a</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>[[#simid-creative-fatalError]]</td>
      <td>n/a</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>[[#simid-creative-getVideoState]]</td>
      <td>[[#simid-creative-getVideoState-resolve]]</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>[[#simid-creative-log]]</td>
      <td>n/a</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>[[#simid-creative-reportTracking]]</td>
      <td>[[#simid-creative-reportTracking-resolve]]</td>
      <td>[[#simid-creative-reportTracking-reject]]</td>
    </tr>
    <tr>
      <td>[[#simid-creative-requestChangeAdDuration]]</td>
      <td>[[#simid-creative-requestChangeAdDuration-resolve]]</td>
      <td>[[#simid-creative-requestChangeAdDuration-reject]]</td>
    </tr>
    <tr>
      <td>[[#simid-creative-requestChangeVolume]]</td>
      <td>[[#simid-creative-requestChangeVolume-resolve]]</td>
      <td>[[#simid-creative-requestChangeVolume-reject]]</td>
    </tr>
    <tr>
      <td>[[#simid-creative-requestFullScreen]]</td>
      <td>[[#simid-creative-requestFullScreen-resolve]]</td>
      <td>[[#simid-creative-requestFullScreen-reject]]</td>
    </tr>
    <tr>
      <td>[[#simid-creative-requestExitFullScreen]]</td>
      <td>[[#simid-creative-requestExitFullScreen-resolve]]</td>
      <td>[[#simid-creative-requestExitFullScreen-reject]]</td>
    </tr>
    <tr>
      <td>[[#simid-creative-requestPause]]</td>
      <td>[[#simid-creative-requestPause-resolve]]</td>
      <td>[[#simid-creative-requestPause-reject]]</td>
    </tr>
    <tr>
      <td>[[#simid-creative-requestPlay]]</td>
      <td>[[#simid-creative-requestPlay-resolve]]</td>
      <td>[[#simid-creative-requestPlay-reject]]</td>
    </tr>
    <tr>
      <td>[[#simid-creative-requestResize]]</td>
      <td>[[#simid-creative-requestResize-resolve]]</td>
      <td>[[#simid-creative-requestResize-reject]]</td>
    </tr>
    <tr>
      <td>[[#simid-creative-requestSkip]]</td>
      <td>[[#simid-creative-requestSkip-resolve]]</td>
      <td>[[#simid-creative-requestSkip-reject]]</td>
    </tr>
    <tr>
      <td>[[#simid-creative-requestStop]]</td>
      <td>[[#simid-creative-requestStop-resolve]]</td>
      <td>[[#simid-creative-requestStop-reject]]</td>
    </tr>
  </tbody>
</table>

## Messages Triggered by Media Element Events ## {#media-messages}

SIMID specifies a group of messages that describe ad media states. The player prepends such messages with the `SIMID:Media namespace`.

SIMID borrows media-related semantics and naming conventions from the standard `HTMLMediaElement` behavior. In player implementations, where an `HTMLMediaElement` is not used, the player must translate events and property values into the associated `SIMID:Media` message.

In HTML environments, `SIMID:Media` messages contain the original media event type. Example:
1. `HTMLMediaElement` dispatches event `play`.
1. Player sets `Message.type = SIMID:Media:play`.

The player must report `SIMID:Media` messages immediately after the associated event occurs.

The player must not queue messages in cases where the creative iframe initialization happens in the middle of the ad media playback. The player posts only messages that communicate events that occur after the iframe initialization.

`SIMID:Media` messages are information-only; they do not trigger `resolve/reject` responses from the creative.

The player may elect to report all standard HTML media events to the creative. However, the creative should not expect to receive messages with optional types. (See <a href="#table-media-events">table</a> below.)

Some `SIMID:Media` messages - `durationchange`, `error`, `timeupdate`, and `volumechange` - require additional data provided with `Message.args` parameters. 

<p table-header id="table-media-events">Required and optional media event types.</p>

<table class="alternatecolor two-col-split">
  <tbody>
    <tr>
      <th>Event Name</th>
      <th>Required</th>
      <th width="2%" style="background:#FF0000"></th>
	  <th>Event Name</th>
      <th>Required</th>
	  <th width="2%" style="background:#FF0000"></th>
	  <th>Event Name</th>
      <th>Required</th>
    </tr>
<tr><td>`abort`</td><td></td><td></td><td>`interruptend`</td><td></td><td></td><td>`seeked`</td><td req></td></tr>
<tr><td>`canplay`</td><td></td><td></td><td>`loadeddata`</td><td></td><td></td><td>`seeking`</td><td req></td></tr>
<tr><td>`canplaythrough`</td><td></td><td></td><td>`loadedmetadata`</td><td></td><td></td><td>`stalled`</td><td req></td></tr>
<tr><td>`durationchange`</td><td req></td><td></td><td>`loadstart`</td><td></td><td></td><td>`suspend`</td><td></td></tr>
<tr><td>`emptied`</td><td></td><td></td><td>`pause`</td><td req></td><td></td><td>`timeupdate`</td><td req></td></tr>
<tr><td>`encrypted`</td><td></td><td></td><td>`play`</td><td req></td><td></td><td>`volumechange`</td><td req></td></tr>
<tr><td>`ended`</td><td req></td><td></td><td>`playing`</td><td req></td><td></td><td class="last-row">`waiting`</td><td class="last-row"></td></tr>
<tr><td>`error`</td><td req></td><td></td><td>`progress`</td><td></td><td></td><td class="empty"></td><td class="empty"></td></tr>
<tr><td>`interruptbegin`</td><td></td><td></td><td>`ratechange`</td><td></td><td></td><td class="empty"></td><td class="empty"></td></tr>

  </tbody>
</table>
### SIMID:Media:durationchange ### {#simid-media-durationchange}

When the duration of the media changes due to the player receiving the media resource metadata (in HTML, `HTMLMediaElement` dispatches the `durationchange` event), the player posts a `SIMID:Media:durationchange` message.

<xmp class="idl">
dictionary MessageArgs {
	required float duration;
};
</xmp>

<dl dfn-type=attribute dfn-for=FooInterface class="idl highlight def">
  <dt><dfn>duration</dfn>
  <dd>The duration of the media in seconds. In HTML, HTMLMediaElement.duration value.*
</dl>
<ul class="footnote">
<li>In SSAI, `HTMLMediaElement.duration` value does not express the actual ad media duration. In such cases, the player must compute the ad’s actual media length.</li>
</ul>
### SIMID:Media:ended ### {#simid-media-ended}
When the media playback completes (in HTML, `HTMLMediaElement` dispatches `ended` event), the player posts a `SIMID:Media:ended` message. 

### SIMID:Media:error ### {#simid-media-error}
When playback throws an exception (in HTML, `HTMLMediaElement` dispatches `error` event), the player posts `SIMID:Media:error` message.

<xmp class="idl">
dictionary MessageArgs {
	required unsigned short error;
	required DOMString message;
};
</xmp>
<dl dfn-type=attribute dfn-for=FooInterface class="idl highlight def">
	<dt><dfn>error</dfn>
	<dd>In HTML, the value of `HTMLMediaElement.error.code`. Codes:
	<ul class="values-list">
		<li>`1` The media download was canceled</li>
		<li>`2` Network error</li>
		<li>`3` The player failed to decode the media</li>
		<li>`4` Environment does not support media resource</li>
	</ul>
  <dt><dfn>message</dfn>
  <dd>In HTML, the value of `HTMLMediaElement.error.message`.
</dl>

### SIMID:Media:pause ### {#simid-media-pause}
When the media pauses (in HTML, `HTMLMediaElement` dispatches `pause` event), the player posts a `SIMID:Media:pause` message.

### SIMID:Media:play ### {#simid-media-play}
When media playback starts as a result of autoplay or its state is no longer paused (in HTML, `HTMLMediaElement` dispatches `play` event),  the player posts a `SIMID:Media:play` message.


### SIMID:Media:playing ### {#simid-media-playing}
The player posts a `SIMID:Media:playing` message in one of the following cases:
* the media has enough data to start playback;
* the media recovered from `stalled` state;
* playback restarts;
* after seek operation completion. 

In HTML, the player posts `Media:play` message when `HTMLMediaElement` dispatches `playing` event.


### SIMID:Media:seeked ### {#simid-media-seeked}
When user finished moving playhead into a new position (in HTML, `HTMLMediaElement` dispatches `seeked` event), the player posts a `SIMID:Media:seeked` message.


### SIMID:Media:seeking ### {#simid-media-seeking}
When user initiates seek operation (in HTML, `HTMLMediaElement` dispatches `seeking` event), the player posts a `SIMID:Media:seeking` message.


### SIMID:Media:stalled ### {#simid-media-stalled}
When media data is not available for rendering (in HTML, `HTMLMediaElement` dispatches `stalled` event), the player posts a `SIMID:Media:stalled` message.

### SIMID:Media:timeupdate ### {#simid-media-timeupdate}
The player communicates media playhead position by posting a `SIMID:Media:timeupdate` message. The message `Media:timeupdate` frequency should be not less than every 250ms.

In HTML, the player sends `Media:timeupdate` message when` HTMLMediaElement` dispatches `timeupdate` event.
<xmp class="idl">
dictionary MessageArgs {
	required float currentTime;
};
</xmp>

<dl dfn-type=attribute dfn-for=MessageArgs class="idl highlight def">
  <dt><dfn>currentTime</dfn>
  <dd>The value in seconds. In HTML, `HTMLMediaElement.currentTime` property value.
</dl>
<p class="note">In Server-Side Ad Insertion, the client-side media playback is a continuous stream, which requires additional `currentTime` calculations. For the current ad, the player must compute `currentTime` value as a delta between the actual playhead position and the time the ad started.</p>


### SIMID:Media:volumechange ### {#simid-media-volumechange}
When the media audio state changes (in HTML, `HTMLMediaElement` dispatches `volumechange` event), the player posts a `SIMID:Media:volumechange` message.
<xmp class="idl">
dictionary MessageArgs {
	required float volume;
	required boolean muted;
};
</xmp>

<dl dfn-type=attribute dfn-for=FooInterface class="idl highlight def">
  <dt><dfn>volume</dfn>
  <dd>The number between `0` and `1`.*
  <dt><dfn>muted</dfn>
  <dd>`true` if audio is muted.*
</dl>
<ul class="footnote">
<li>Properties `volume` and `muted` describe two independent audio states. While media is muted, its `volume` may be greater than zero; while `volume` is zero, media may be unmuted.</li>
</ul>

## Messages from the player ## {#player-messages}
SIMID specifies a group of messages that enables the player to transmit data, instructions, or state changes to the creative. The player prepends such message types with the `SIMID:Player` namespace.

`SIMID:Player` messages do not communicate ad media states; SIMID dedicates [[#media-messages]] to report media status.

While some `SIMID:Player` messages expect `resolve` and/or `reject` creative responses, other messages do not require replies.

<p table-header id="table-player-messages">`SIMID:Player` messages summary.</p>
<table class="alternatecolor messages-summary">
	<tbody>
		<tr>
			<th width="40%">Message type</th>
			<th width="30%">`ars` parameters</th>
			<th width="30%">Responses</th>
		</tr>
		<tr>
			<td>[[#simid-player-adSkipped]]</td>
			<td>n/a</td>
			<td>[[#simid-player-adSkipped-resolve]]</td>
		</tr>
		<tr>
			<td>[[#simid-player-adStopped]]</td>
			<td>`code`</td>
			<td>[[#simid-player-adStopped-resolve]]</td>
		</tr>
		<tr>
			<td>[[#simid-player-app-backgrounding]]</td>
			<td>n/a</td>
			<td>[[#simid-player-app-backgrounding-resolve]]</td>
		</tr>
		<tr>
			<td>[[#simid-player-app-foregrounding]]</td>
			<td>n/a</td>
			<td>n/a</td>
		</tr>
		<tr>
			<td>[[#simid-player-fatalError]]</td>
			<td>`errorCode`<br>`errorMessage`</td>
			<td>[[#simid-player-fatalError-resolve]]</td>
		</tr>
		<tr>
			<td>[[#simid-player-init]]</td>
			<td>`environmentData`<br>`creativeData`</td>
			<td>[[#simid-player-init-resolve]]<br>[[#simid-player-init-reject]]</td>
		</tr>
		<tr>
			<td>[[#simid-player-log]]</td>
			<td>`message`</td>
			<td>n/a</td>
		</tr>
		<tr>
			<td>[[#simid-player-resize]]</td>
			<td>`mediaDimensions`<br>`creativeDimensions`<br>`fullScreen`</td>
			<td>n/a</td>
		</tr>
		<tr>
			<td>[[#simid-player-startCreative]]</td>
			<td>n/a</td>
			<td>[[#simid-player-startCreative-resolve]]<br>[[#simid-player-startCreative-reject]]</td>
		</tr>
		
	</tbody>
</table>

### SIMID:Player:adSkipped ### {#simid-player-adSkipped}
The player posts a `SIMID:Player:adSkipped` message immediately after the user ends ad experience. For example, by clicking on the player-owned <button skip-ad>Skip Ad</button> button. The player must stop the media and hide the creative iframe before sending the `Player:adSkipped` message.


The player waits for the `resolve` creative response. The player may time out if the creative takes too long to respond and unload the iframe. The timeout should be reasonable to allow creative to conclude ad-end logic.  

#### resolve #### {#simid-player-adSkipped-resolve}
The creative must respond to `Player:adSkipped` with `resolve` once its internal ad-end processes finalize. When the player receives `resolve`, it unloads the creative iframe.

### SIMID:Player:adStopped ### {#simid-player-adStopped}
The player posts a `SIMID:Player:adStopped` message immediately after it terminates the ad for any reason other than a user generated skip.  See [[#simid-player-adSkipped]].

The player must stop media playback and hide the creative iframe before reporting `Player:adStopped`. The player must wait for a `resolve` response from the creative allotting a reasonable timeout to accommodate creative’s needs to finalize the ad-end logic.
<xmp class="idl">
dictionary MessageArgs {
	required unsigned short code;
};
</xmp>
<dl dfn-type=attribute dfn-for=FooInterface class="idl highlight def">
	<dt><dfn>code</dfn>
	<dd>Ad stop cause code. Values:
	<ul class="values-list">
		<li>`0` Unspecified</li>
		<li>`1` User-initiated close</li>
		<li>`2` Auto-close due to media playback completion</li>
		<li>`3` Player-initiated close before media playback completion</li>
		<li>`4` Creative-initiated close</li>
	</ul>
</dl>

#### resolve #### {#simid-player-adStopped-resolve}
The creative must respond to `Player:adStopped` with `resolve` once its internal ad-end processes finalize. When the player receives `resolve`, it unloads the creative iframe.

### SIMID:Player:appBackgrounding ### {#simid-player-app-backgrounding}
Within mobile in-app ads, when the app moves to the background, the player posts a `SIMID:Player:appBackgrounding` message.

#### resolve #### {#simid-player-app-backgrounding-resolve}


<p class="note" warning>Response to `appBackgrounding` with `resolve` has been deprecated.</p>

### SIMID:Player:appForegrounding ### {#simid-player-app-foregrounding}
Within mobile in-app ad executions, when the app moves from the background to the foreground, the player posts a `SIMID:Player:appForegrounding` message.

### SIMID:Player:fatalError ### {#simid-player-fatalError}
The player posts a `SIMID:Player:fatalError` message when it encounters exceptions that disqualify the ad from displaying any longer. If feasible, the player stops the ad media. Regardless of the player's ability to terminate playback, the player should hide creative iframe and wait for `resolve` response before unloading iframe.

<xmp class="idl">
dictionary MessageArgs {
	required unsigned short errorCode;
	DOMString errorMessage;
};
</xmp>
<dl dfn-type=attribute dfn-for=FooInterface class="idl highlight def">
	<dt><dfn>errorCode</dfn>
	<dd>See § 8.4 Error Codes.
	<dt><dfn>errorMessage</dfn>
	<dd>Additional information
</dl>

#### resolve #### {#simid-player-fatalError-resolve}
The creative must respond to `Player:fatalError` with `resolve`. After `resolve arrives`, the player should remove the iframe. 

### SIMID:Player:init ### {#simid-player-init}
The purpose of the `SIMID:player:init` message is to transport data to assist with the interactive component initialization. See <a href="#diagram-player-init-normal">Diagram 5. Normal Creative Initilaizatioin Sequence</a>.

The player should post `Player:init` as soon as the iframe dispatches a load event (<a href="#diagram-player-init-normal">diagram</a>, <span steps><b>3</b><b>4</b></span>). SIMID creative code must be ready to process `Player:init` message immediately (<a href="#diagram-player-init-normal">diagram</a>, <span steps><b>5</b></span>). 

The creative must respond to `Player:init` with either [[#simid-player-init-resolve]] or [[#simid-player-init-reject]]. 

**Typical flow**

The cohesive linear ad experience implies the simultaneous start of media playback and display of the functional interactive overlay. Once the SIMID interactive module consumes information transmitted by the `init` message, its internal sub-loading sequences and dynamic data-driven logic may create delays in creative readiness. To accommodate these latencies, the player posts an `init` message before ad media playback begins and waits for the SIMID iframe to respond with resolve. After the player gets a resolve message (<a href="#diagram-player-init-normal">diagram 5</a>, <span steps><b>4</b></span>), it posts [[#simid-player-startCreative]] at its discretion (<a href="#diagram-player-init-normal">diagram 5</a>, <span steps><b>5</b></span>). 

<div diagram id="diagram-player-init-normal">
	<p>Normal Creative Initilaization Sequence</p>
	<img src="images/dgrm-init-normal.png" alt="Normal Creative Initilaizatioin Sequence"/>
	<ol dgrm-details>
		<li>Creative initializes the session.</li>
		<li>Player posts `Player:init` message immediately upon session creation.</li>
		<li>Creative proccesses initialization data and finalizes assets loading. Sub-loading routines may cause latencies.</li>
		<li>Creative responds with [[#simid-player-init-resolve]].</li>
		<li>Player posts [[#simid-player-startCreative]] when it is ready to render interactive component.</li>
	</ol>
</div>


**Special Cases**

See <a href="#diagram-player-init-special">Diagram 6. Special Creative Initialization Cases</a>. 

Certain publisher environments prohibit media playback interruptions; as a result, waiting for the interactive portion of the ad experience to be available is not possible. The media player renders the ad media immediately - before creative confirms its readiness. (<a href="#diagram-player-init-special">diagram 6</a>, <span steps><b>1</b></span>). Some examples include SSAI and live broadcasts. 

In these situations, as with the typical flow, the player keeps iframe invisible and refrains from the further posting of messages to creative until `resolve` response comes.

<div diagram id="diagram-player-init-special">
	<p>Special Creative Initialization Cases</p>
	<img src="images/dgrm-init-special.png" alt="Creative initialization slecial cases sequence">
	<ol dgrm-details>
		<li>Player initializes ad media playback.</li>
		<li>Player posts `Player:init` message after ad media playback started.</li>
		<li>Creative proccesses initialization data and finalizes assets loading. Sub-loading routines may cause latencies.</li>
		<li>Creative responds with [[#simid-player-init-resolve]].</li>
		<li>Player posts [[#simid-player-startCreative]] when it is ready to render interactive component.</li>
	</ol>
</div>


<xmp class="idl">
dictionary MessageArgs {
	required EnvironmentData environmentData;
	required CreativeData creativeData;
};
</xmp>
<dl dfn-type=attribute dfn-for=FooInterface class="idl highlight def">
	<dt><dfn>environmentData</dfn>
	<dd>Information about publisher’s environment and media player capacities.
	<dt><dfn>creativeData</dfn>
	<dd>Information that pertains to the specific creative.
</dl>


<xmp class="idl">
dictionary CreativeData {
	required DOMString adParameters;
	DOMString clickThruUrl;
};
</xmp>
<dl dfn-type=attribute dfn-for=FooInterface class="idl highlight def">
	<dt><dfn>adParameters</dfn>
	<dd>Typically, the value of VAST `<AdParameters>` node.
	<dt><dfn>clickThruUrl</dfn>
	<dd>Value of VAST `<ClickThrough>` node.
</dl>

<xmp class="idl">
dictionary EnvironmentData {
	required Dimensions videoDimensions;
	required Dimensions creativeDimensions;
	required boolean fullScreen;
	required boolean fullscreenAllowed;
	required boolean variableDurationAllowed;
	required SkippableState skippableState;
	required DOMString version;
	DOMString siteUrl;
	DOMString appId;
	DOMString useragent;
	DOMString deviceId;
	boolean muted;
	float volume;
};

dictionary Dimensions {
	required long x;
	required long y;
	required long width;
	required long height;
};

enum SkippableState {"playerHandles", "adHandles", "notSkippable"};
</xmp>

<dl dfn-type=attribute dfn-for=FooInterface class="idl highlight def">
	<dt><dfn>videoDimensions</dfn>
	<dd>Communicates media element coordinates and size.
	<dt><dfn>creativeDimensions</dfn>
	<dd>Communicates creative iframe coordinates and size the player will set when iframe becomes visible.
	<dt><dfn>fullScreen</dfn>
	<dd>The value `true` indicates that the player is currently in full-screen mode.
	<dt><dfn>fullscreenAllowed</dfn>
	<dd>Communicates the player’s capacity to toggle screen modes.
	<ul collapse>
		<li>The value `true` indicates that creative may request screen mode change.</li>
		<li>The value `false` denotes that the player will reject calls to change screen mode.*</li>
	</ul>

	<dt><dfn>variableDurationAllowed</dfn>
	<dd>Communicates player’s capacities† to:
		<ol collapse alpha>
			<li>interrupt ad playback progress – the ability to pause the media;</li>
			<li>extend ad user experience length beyond ad media duration after ad playback completion;</li>
			<li>accommodate creative’s ad stop request.</li>
		</ol>
		The value `true` asserts that the player can:
		<ul collapse>
			<li>pause media playback in response to creative’s requests;</li>
			<li>extend ad experience after media playback completion (and abstaining from ad unloading) if the creative posts ad duration change instructions;</li>
			<li>accommodate creative’s ad stop request.‡</li>
		</ul>
	<dt><dfn>skippableState</dfn>
		<dd>Expresses:
			<ol collapse alpha>
				<li>player’s ability to skip the ad;†</li>
				<li>VAST skippability-associated instructions logic management;</li>
				<li><button skip-ad>Skip Ad</button> button handling delegation.</li>
			</ol>
			The value `playerHandles` indicates that all of the following applies:
			<ul collapse>
				<li>the publisher controls skippability logic (including handling of VAST `skipoffset` directives);</li>
				<li>either VAST contains `skipoffset` or the skippability is the publisher-administered behavior;</li>
				<li>the player implements the <button skip-ad>Skip Ad</button> button;</li>
				<li>the player will ignore skip requests from the creative.</li>
			</ul>
			The value `adHandles` signals that the player:
			<ul collapse>
				<li>can skip the ad;</li>
				<li>does not implement internal <button skip-ad>Skip Ad</button> button;</li>
				<li>disregards VAST skippability directives;</li>
				<li>will skip the ad in response to [[#simid-creative-requestSkip]] message.§</li>
			</ul>
			The value `notSkippable` declares that the player:
			<ul collapse>
				<li>cannot skip the ad;</li>
				<li>ignores VAST skippability instructions;</li>
				<li>will disregard skip request from the creative.</li>
			</ul>
			With both `playerHandles` and `notSkippable`, the creative avoids the <button skip-ad>Skip Ad</button> button drawing.
	<dt><dfn>version</dfn>
	<dd>The SIMID version the player implements.
	<dt><dfn>muted</dfn>
	<dd>`true` if the player § is muted.◊
	<dt><dfn>volume</dfn>
	<dd>player’s § volume – expressed as a number between `0` and `1.0`.
	<dt><dfn>siteUrl</dfn>
	<dd>The URI of the publisher’s site. May be full or partial URL.
	<dt><dfn>appId</dfn>
	<dd>The ID of the mobile app, if applicable.
	<dt><dfn>useragent</dfn>
	<dd>The information about SDKs as well as the player’s vendor and version. The value should comply with VAST-specified conventions.
	<dt><dfn>deviceId</dfn>
	<dd>IDFA or AAID
	
	
</dl>

<ul class="footnote">
	<li>see [[#simid-creative-requestFullScreen]] and [[#simid-creative-requestExitFullScreen]] messages.</li>
	<li>In SSAI, live broadcast, and other time-constrained environments, the player must support uninterrupted media (both content and ads) playback progress. Specifically, the player may not be able to pause the media, shorten ad, or extend user ad experience.</li>
	<li>see [[#simid-creative-requestPause]], [[#simid-creative-requestPlay]], [[#simid-creative-requestChangeAdDuration]], and [[#simid-creative-requestStop]].</li>
	<li>SIMID does not expect device audio state information.</li>
	<li>Values of `muted` and `volume` are independent. While the player is muted, `volume` can be greater than zero; the `volume` zero does not mean the player is muted.</li>
</ul>

#### resolve #### {#simid-player-init-resolve}

See <a href="#diagram-player-init-resolve-timeout">Diagram 7. `Player:init resolve` Timeout Sequence</a>.

The creative responding to `Player:init` with a `resolve` message is the critical step in SIMID ad serving flow (<a href="#diagram-player-init-special">diagram 6</a>,  <span steps><b>4</b></span> above). The player keeps SIMID iframe invisible and does not post either `SIMID:Player` or `SIMID:Media` messages until the iframe replies with a `resolve`.

The player may elect to unload the iframe that fails to respond with a resolution within a reasonable time. If the creative fails to respond to a `Player:init`, to proceed with a usable impression, the player may continue with ad media rendering only (<a href="#diagram-player-init-resolve-timeout">diagram 7</a>,  <span steps><b>2</b></span>). In such cases, the player must report the VAST error tracker (if available) with the code XXX (<a href="#diagram-player-init-resolve-timeout">diagram 7</a>,  <span steps><b>5</b></span>).


<div diagram id="diagram-player-init-resolve-timeout">
	<p>`Player:init resolve` Timeout Sequence</p>
	<img src="images/dgrm-init-resolve-timeout.png" alt="Player:init resolve timeout">
	<ol dgrm-details>
		<li>Player posts `Player:init` message and establishes a timeout.</li>
		<li>Player starts ad media playback upon timeout expiration.</li>
		<li>Player unloads the creative iframe.</li>
		<li>Player reports impression tracker.</li>
		<li>Player reports error tracker.</li>
	</ol>
</div>



#### reject #### {#simid-player-init-reject}

See <a href="#diagram-player-init-reject">Diagram 8. `Player:init reject` Sequence</a>.

The creative may respond with a `reject` based on its internal logic. Under typical circumstances, in reaction to a `reject`, the player should abandon the ad.

If the player cannot discard the ad (for example with a live stream), it unloads the iframe, plays the ad media, and reports impression, similar to the response timeout flow rules.

<div diagram id="diagram-player-init-reject">
	<p>`Player:init reject` Timeout Sequence</p>
	<img src="images/dgrm-init-reject-timeout.png" alt="Player:init reject sequence.">
	<ol dgrm-details>
		<li>Player posts `Player:init` message.</li>
		<li>Creative responds with a `reject`.</li>
		<li>Player unloads the creative iframe.</li>
		<li>Player abandons the ad.</li>
	</ol>
</div>


<xmp class="idl">
dictionary MessageArgs {
	required unsigned short errorCode;
	DOMString reason;
};
</xmp>
<dl dfn-type=attribute dfn-for=FooInterface class="idl highlight def">
	<dt><dfn>errorCode</dfn>
	<dd>See [[#error-codes]].
	<dt><dfn>reason</dfn>
	<dd>Optional information about rejection cause.
</dl>

### SIMID:Player:log ### {#simid-player-log}
The purpose of the Player:log message is to convey optional, primarily debugging, information to the creative.

Note: If the player posts log message to communicate creative’s performance inefficiencies or specifications deviations that do not impede ad experience progress, the player should prefix the message parameter value with “WARNING:” string. Warning messages are used to inform interested parties about non-fatal issues occurring. 


<xmp class="idl">
dictionary MessageArgs {
	required DOMString message;
};
</xmp>
<dl dfn-type=attribute dfn-for=FooInterface class="idl highlight def">
	<dt><dfn>message</dfn>
	<dd>Logging information.
</dl>

### SIMID:Player:resize ### {#simid-player-resize}
When the player changes any of ad components’ size, it posts the `SIMID:Player:resize` message. The message describes the media and creative sizes, independently, even if the dimensions are identical.

<xmp class="idl">
dictionary MessageArgs {
	required Dimensions videoDimensions;
	required Dimensions creativeDimensions;
	required boolean fullScreen;
};

dictionary Dimensions {
	required long x;
	required long y;
	required long width;
	required long height;
};
</xmp>
<dl dfn-type=attribute dfn-for=FooInterface class="idl highlight def">
	<dt><dfn>mediaDimensions</dfn>
	<dd>Media element size and coordinates.
	<dt><dfn>creativeDimensions</dfn>
	<dd>SIMID iframe size and coordinates.*
	<dt><dfn>fullScreen</dfn>
	<dd>Value is `true` when the ad is in full-screen mode.
</dl>
<ul class="footnote">
	<li>If the  iframe is invisible at the time the player posts `resize` message, the parameter `creativeDimensions` communicates forthcoming values: iframe's size, and coordinates once it is displayed.</li>
</ul>

### SIMID:Player:startCreative ### {#simid-player-startCreative}

See <a href="#diagram-player-startcreative">Diagram 9. Normal `Player:startCreative` Sequence</a>.

The player posts `SIMID:player:startCreative` when it is ready to make the iframe visible. Under a typical flow, the player waits for a [[#simid-player-startCreative-resolve]] to display the SIMID iframe and to start media playback.

In the circumstances that require uninterrupted media playback, the player posts `Player:startCreative` in the middle of the ad experience. See [[#simid-player-init]], section "Special Cases". 

<div diagram id="diagram-player-startcreative">
	<p>Normal `Player:startCreative` Sequence</p>
	<img src="images/dgrm-startCreative-normal.png" alt="startCreative normal sequence.">
	<ol dgrm-details>
		<li>Player posts `Player:startCreative`.</li>
		<li>Creative responds with a `resolve`.</li>
		<li>Player displays the creative iframe.</li>
		<li>Player starts ad media playback.</li>
	</ol>
</div>


#### resolve #### {#simid-player-startCreative-resolve}
By posting `resolve`, the creative acknowledges that it is ready for display. The player makes the iframe visible immediately upon a `resolve` receipt (<a href="#diagram-player-startcreative">diagram 9</a>,  <span steps><b>2</b></span>).


#### reject #### {#simid-player-startCreative-reject}

See <a href="#diagram-player-startcreative-reject">Diagram 10. `Player:startCreative reject` Sequence</a>.

By posting a `reject` message, the creative expresses a preference to stop ad execution. Normally, when the creative responds with a `reject`, the player unloads the iframe and abandons ad media. In certain cases (SSAI or live streaming), ad media playback may still happen at the discretion of the player (<a href="#diagram-player-startcreative-reject">diagram 10</a>,  <span steps><b>5</b></span>).

If the player continues with the ad media playback despite the `reject` response to `Player:creativeStart`, it sends the VAST error tracker, if available, with the code provided by `reject` message `errorCode` argument (<a href="#diagram-player-startcreative-reject">diagram 10</a>,  <span steps><b>5.2</b></span>).  

<div diagram id="diagram-player-startcreative-reject">
	<p>`Player:startCreative reject` Sequence</p>
	<img src="images/dgrm-startCreative-reject.png" alt="startCreative reject sequence.">
	<ol dgrm-details>
		<li>Player posts `Player:startCreative`.</li>
		<li>Creative responds with a `reject`.</li>
		<li>Player unloads the creative iframe.</li>
		<li><b>Typical flow:</b> the  player abandons the ad.</li>
		<li><b>Alternative flow:</b> the player starts ad media playback.
		<ol>
			<li>Player sends impression tracker.</li>
			<li>Player reports error tracker.</li>
		</ol>
		</li>
	</ol>
</div>

<xmp class="idl">
dictionary MessageArgs {
	required unsigned short errorCode;
	DOMString reason;
};
</xmp>
<dl dfn-type=attribute dfn-for=FooInterface class="idl highlight def">
	<dt><dfn>errorCode</dfn>
	<dd>See [[#error-codes]].
	<dt><dfn>reason</dfn>
	<dd>Additional information.
	
</dl>

## Messages from the Creative to the Player ## {#creative-messages}
The creative posts messages to the player to requests the ad’s state changes, obtain data, and to send notifications. The creative prefixes its messages with the namespace `SIMID:Creative`.

`SIMID:Creative` messages may require the player to accept and process arguments. With some messages, the creative expects the player to respond with resolutions.

<p table-header id="table-creative-messages">`SIMID:Creative` messages summary.</p>

<table class="alternatecolor messages-summary">
	<tbody>
		<tr>
			<th width="50%">Message type</th>
			<th width="25%">`ars` parameters</th>
			<th width="25%">Responses</th>
		</tr>
		<tr>
			<td>[[#simid-creative-clickThru]]</td>
			<td>`x`<br>`y`</td>
			<td>n/a</td>
		</tr>
		<tr>
			<td>[[#simid-creative-fatalError]]</td>
			<td>`errorCode`<br>`errorMessage`</td>
			<td>n/a</td>
		</tr>
		<tr>
			<td>[[#simid-creative-getVideoState]]</td>
			<td>n/a</td>
			<td>[[#simid-creative-getVideoState-resolve]]</td>
		</tr>
		<tr>
			<td>[[#simid-creative-log]]</td>
			<td>`message`</td>
			<td>n/a</td>
		</tr>
			<td>[[#simid-creative-reportTracking]]</td>
			<td>`trackingUrls`</td>
			<td>[[#simid-creative-reportTracking-resolve]]<br>[[#simid-creative-reportTracking-reject]]</td>
		</tr>
		</tr>
			<td>[[#simid-creative-requestChangeAdDuration]]</td>
			<td>`duration`</td>
			<td>[[#simid-creative-requestChangeAdDuration-resolve]]<br>[[#simid-creative-requestChangeAdDuration-reject]]</td>
		</tr>
		</tr>
			<td>[[#simid-creative-requestChangeVolume]]</td>
			<td>`volume`<br>`muted`</td>
			<td>[[#simid-creative-requestChangeVolume-resolve]]<br>[[#simid-creative-requestChangeVolume-reject]]</td>
		</tr>
		</tr>
			<td>[[#simid-creative-requestExitFullScreen]]</td>
			<td>n/a</td>
			<td>[[#simid-creative-requestExitFullScreen-resolve]]<br>[[#simid-creative-requestExitFullScreen-reject]]</td>
		</tr>
		</tr>
			<td>[[#simid-creative-requestFullScreen]]</td>
			<td>n/a</td>
			<td>[[#simid-creative-requestFullScreen-resolve]]<br>[[#simid-creative-requestFullScreen-reject]]</td>
		</tr>
		</tr>
			<td>[[#simid-creative-requestPause]]</td>
			<td>n/a</td>
			<td>[[#simid-creative-requestPause-resolve]]<br>[[#simid-creative-requestPause-reject]]</td>
		</tr>
		</tr>
			<td>[[#simid-creative-requestPlay]]</td>
			<td>n/a</td>
			<td>[[#simid-creative-requestPlay-resolve]]<br>[[#simid-creative-requestPlay-reject]]</td>
		</tr>
		</tr>
			<td>[[#simid-creative-requestResize]]</td>
			<td>n/a</td>
			<td>[[#simid-creative-requestResize-resolve]]<br>[[#simid-creative-requestResize-reject]]</td>
		</tr>
		</tr>
			<td>[[#simid-creative-requestSkip]]</td>
			<td>n/a</td>
			<td>[[#simid-creative-requestSkip-resolve]]<br>[[#simid-creative-requestSkip-reject]]</td>
		</tr>
		</tr>
			<td>[[#simid-creative-requestStop]]</td>
			<td>n/a</td>
			<td>[[#simid-creative-requestStop-resolve]]<br>[[#simid-creative-requestStop-reject]]</td>
		</tr>
		
	</tbody>
</table>


### SIMID:Creative:clickThru ### {#simid-creative-clickThru}

The purpose of a `SIMID:Creative:clickThru` message is to assist the player with `clickthrough` tracking. SIMID delegates clickthrough execution to the creative, including redirecting the user to the landing page. The interactive component posts `clickThru` only when the creative classifies a user interaction as a clickthrough.

The message `clickThru` is not an explicit media-pausing directive to the player. If the environment permits, the player should pause ad media in all cases when the user navigates away from the player hosting page or app, including clickthrough. See [Page Visibility API](https://developer.mozilla.org/en-US/docs/Web/API/Page_Visibility_API).

<xmp class="idl">
dictionary MessageArgs {
	short x;
	short y;
};
</xmp>
<dl dfn-type=attribute dfn-for=FooInterface class="idl highlight def">
	<dt><dfn>x</dfn>
	<dd>The click left offset in the creative’s coordinate system.
	<dt><dfn>y</dfn>
	<dd>The click top offset in the creative’s coordinate system.
	
</dl>


### SIMID:Creative:fatalError ### {#simid-creative-fatalError}
The creative posts `SIMID:Creative:fatalError` in cases when its internal exceptions prevent the interactive component from further execution. In response to the `fatalError` message, the player unloads the SIMID iframe and, if possible, ends ad media playback. 

<xmp class="idl">
dictionary MessageArgs {
	required insigned short errorCode;
	DOMString errorMessage;
};
</xmp>
<dl dfn-type=attribute dfn-for=FooInterface class="idl highlight def">
	<dt><dfn>errorCode</dfn>
	<dd>See [[#error-codes]].
	<dt><dfn>errorMessage</dfn>
	<dd>Additional information.
	
</dl>

### SIMID:Creative:getVideoState ### {#simid-creative-getVideoState}
The creative posts a `SIMID:Creative:getVideoState` message to request the current ad media states values.


#### resolve #### {#simid-creative-getVideoState-resolve}
The player should always respond  to `Creative:getVideoState` with a `resolve`, including situations when the player is unable to provide all expected values. 

<xmp class="idl">
dictionary MessageArgs {
	DOMString currentSrc;
	float currentTime;
	float duration;
	boolean ended;
	boolean muted;
	boolean paused;
	float volume;
	boolean fullscreen;
};
</xmp>
<dl dfn-type=attribute dfn-for=FooInterface class="idl highlight def">
	<dt><dfn>currentSrc</dfn>
	<dd>The URI to the media publisher chooses for the playback. This value is optional and may not be provided in the case of server side ad insertion.
	<dt><dfn>currentTime</dfn>
	<dd>The time elapsed since the first ad media frame.
	<dt><dfn>duration</dfn>
	<dd>Ad media duration.
	<dt><dfn>ended</dfn>
	<dd>In HTML, the value of `HTMLMediaElement.ended` attribute. 
	<dt><dfn>muted</dfn>
	<dd>In HTML, the value of `HTMLMediaElement.muted` attribute. 
	<dt><dfn>paused</dfn>
	<dd>In HTML, the value of `HTMLMediaElement.paused` attribute. 
	<dt><dfn>volume</dfn>
	<dd>In HTML, the value of `HTMLMediaElement.volume` attribute. 
	<dt><dfn>fullscreen</dfn>
	<dd>he value is `true` if the media element is in full screen.. 
	
	
</dl>

### SIMID:Creative:log ### {#simid-creative-log}
The message `SIMID:Creative:log` enables the creative to communicate arbitrary information to the player.


Note: If the `log` message purpose is to notify the player about the player’s non-standard behavior, the creative prepends `Message.args.message` value with “WARNING:” `string`. Warning messages are used to inform interested parties about occuraeces of non-fatal issues. 

<xmp class="idl">
dictionary MessageArgs {
	required DOMString message;
};
</xmp>
<dl dfn-type=attribute dfn-for=FooInterface class="idl highlight def">
	<dt><dfn>message</dfn>
	<dd>Logging information.
</dl>

### SIMID:Creative:reportTracking ### {#simid-creative-reportTracking}

The `SIMID:Creative:reportTracking` message enables a creative to delegate arbitrary metrics reporting to the player.

The creative may inject macros into trackers URIs.  

In response to the `reportTracking` message, the player must:
	<ul collapse>
		<li>Send the trackers specified by the message as soon as possible.</li>
		<li>Replace VAST-supported macros with the corresponding values.</li>
		<li>Accept and send the trackers with custom macros – leave non-standard macros intact unless the publisher-ad integration involves custom macros processing.</li>
	</ul>
 
<xmp class="idl">
dictionary MessageArgs {
	required Array trackingUrls;
};
</xmp>
<dl dfn-type=attribute dfn-for=FooInterface class="idl highlight def">
	<dt><dfn>trackingUrls</dfn>
	<dd>`Array` of URIs.
</dl>

#### resolve #### {#simid-creative-reportTracking-resolve}
The player posts a `resolve` after it sends the trackers. 

#### reject #### {#simid-creative-reportTracking-reject}
The player posts a `reject` if it did not send the trackers.

<xmp class="idl">
dictionary MessageArgs {
	required unsigned short errorCode;
	DOMString reason;
};
</xmp>
<dl dfn-type=attribute dfn-for=FooInterface class="idl highlight def">
	<dt><dfn>errorCode</dfn>
	<dd>See [[#error-codes]].
	<dt><dfn>reason</dfn>
	<dd>Additional information.
</dl>

### SIMID:Creative:requestChangeAdDuration ### {#simid-creative-requestChangeAdDuration}

See <a href="#diagram-durationchange-known">Diagram 11. Known Ad Duration Change Sequence</a> and <a href="#diagram-durationchange-unknown">Diagram 12. Unknown Ad Duration Change Sequence</a>.

In SIMID, ad's media determines the initial ad duration. The ad span may change due to user interaction or other factors. When ad duration changes, the creative posts `Creative:requestChangeAdDuration` message that communicates an updated value. In response to the `requestChangeAdDuration` message, the player adjusts ad-end timing and updates its ad progress UI (eg., countdown).

The creative expresses a known duration value in seconds. In cases the duration is unknown (typically due to user interaction), the value is `-2`. With a known duration, the player unloads the ad automatically once the countdown (ad remaining time) reaches zero (<a href="#diagram-durationchange-known">diagram 11</a>,  <span steps><b>4</b><b>5</b><b>6</b></span>). With the duration value `-2`, the player displays the ad indefinitely until the creative posts [[#simid-creative-requestStop]] (<a href="#diagram-durationchange-unknown">diagram 12</a>,  <span steps><b>4</b></span>). 

Note: The player communicates its capacities to modify the ad duration with  [[#simid-player-init]] message args parameter `variableDurationAllowed`. If the value of `variableDurationAllowed` is `false`, the creative refrains from posting `requestChangeAdDuration` message.

<xmp class="idl">
dictionary MessageArgs {
	required float duration;
};
</xmp>
<dl dfn-type=attribute dfn-for=FooInterface class="idl highlight def">
	<dt><dfn>duration</dfn>
	<dd>Value in seconds for a known duration.<br>
	The value `-2` indicates an unknown duration. 
</dl>

<div diagram id="diagram-durationchange-known">
	<p>Known Ad Duration Change Sequence</p>
	<img src="images/dgrm-requestChangeAdDuration-known.png" alt="srequestChangeAdDuration known duration change handling.">
	<ol dgrm-details>
		<li>Player starts countdown. Countdown depends on the media progress.</li>
		<li>Creative posts `requestChangeAdDuration` with the `duration` value greater than zero.</li>
		<li>Player modifies countdown that now depends on the specified by the creative ad duration.</li>
		<li>Countdown finishes.</li>
		<li>Player receives countdown completion notification.</li>
		<li>Player posts [[#simid-player-adStopped]] message.</li>
	</ol>
</div>

<div diagram id="diagram-durationchange-unknown">
	<p>Unkonw Ad Duration Change Sequence</p>
	<img src="images/dgrm-requestChangeAdDuration-unknown.png" alt="srequestChangeAdDuration unknown duration change handling.">
	<ol dgrm-details>
		<li>Player starts countdown. Countdown depends on the media progress.</li>
		<li>Creative posts `requestChangeAdDuration` with the `duration` value `-2`.</li>
		<li>Player stops countdown.</li>
		<li>Creative posts [[#simid-creative-requestStop]] message.</li>
	</ol>
</div>



#### resolve #### {#simid-creative-requestChangeAdDuration-resolve}
By posting `resolve` response to `requestChangeAdDuration` message, the player signals that it will respect requested duration by modifying the ad duration-dependent behaviors.

Note: The player must accommodate an ad duration change directive if the value of the [[#simid-player-init]] message parameter `variableDurationAllowed` is `true`. 


#### reject #### {#simid-creative-requestChangeAdDuration-reject}
By posting `reject` response to `requestChangeAdDuration` message, the player states that:
	<ul collapse>
		<li>It ignored the duration change request;</li>
		<li>Ad media playback continues uninterrupted;</li>
		<li>The player will stop and unload the ad once any of the prescribed player-side ad-end triggers arise.</li>
	</ul>

Note: The single SIMID-supported reason for a `reject` in response to `requestChangeAdDuration` is the player’s inability to alter media progress. 


### SIMID:Creative:requestChangeVolume ### {#simid-creative-requestChangeVolume}
The creative requests ad volume change by posting a `SIMID:Creative:requestChangeVolume` message.

<xmp class="idl">
dictionary MessageArgs {
	required float volume;
	required boolean muted;
};
</xmp>
<dl dfn-type=attribute dfn-for=FooInterface class="idl highlight def">
	<dt><dfn>volume</dfn>
	<dd>The number between `0` and `1`.*
	<dt><dfn>muted</dfn>
	<dd>`true` if media audio should be muted.* 
</dl>
<ul class="footnote">
<li>Properties `volume` and `muted` describe two independent audio states. While media is muted, its volume may be greater than zero; at the same time with zero volume, media may be unmuted.
</li>
</ul>

#### resolve #### {#simid-creative-requestChangeVolume-resolve}
By posting `resolve` message, the player signals it has changed the media audio states to the requested values.
#### reject #### {#simid-creative-requestChangeVolume-reject}
By posting `reject` message, the player signals that it did not change the audio state.

### SIMID:Creative:requestFullScreen ### {#simid-creative-requestFullScreen}
The creative requests the player to transition the ad into full-screen mode by posting a `SIMID:Creative:requestFullScreen` message.

Note: the player communicates its capacity to toggle screen modes with [[#simid-player-init]] message parameter `fullscreenAllowed`. When the value of `fullscreenAllowed` is `false`, the creative refrains from posting `Creative:requestFullScreen` message.

#### resolve #### {#simid-creative-requestFullScreen-resolve}
By posting `resolve` response to `requestFullScreen` message, the player signals that it moved both the media element and the SIMID iframe into full-screen mode.

#### reject #### {#simid-creative-requestFullScreen-reject}
By posting `reject` response to `requestFullScreen` message, the player signals that it did not change the screen mode because it is either:
	<ul collapse>
		<li>Incapable of toggling between screen modes.</li>
		<li>Already in the full-screen mode.</li>
		<li>Disallows full-screen mode.</li>
	</ul>

### SIMID:Creative:requestExitFullScreen ### {#simid-creative-requestExitFullScreen}
The creative requests the player to transition the ad into normal-screen mode by posting a `SIMID:Creative:requestExitFullScreen` message.

Note: the player communicates its capacity to toggle screen modes with [[#simid-player-init]] message parameter `fullscreenAllowed`. When the value of `fullscreenAllowed` is false, the creative refrains from posting `Creative:requestExitFullScreen` message.

#### resolve #### {#simid-creative-requestExitFullScreen-resolve}
By posting `resolve` response to `requestExitFullScree`n message, the player signals that it moved both the media element and the SIMID iframe into normal-screen mode.

#### reject #### {#simid-creative-requestExitFullScreen-reject}
The player responds to `requestExitFullScreen` message with a `reject` when it did not change the screen mode because it is either:
	<ul collapse>
		<li>Incapable of toggling between screen modes or</li>
		<li>Already in the normal-screen mode.</li>
	</ul>


### SIMID:Creative:requestPause ### {#simid-creative-requestPause}
The creative requests the player to pause media playback by posting a `SIMID:Creative:requestPause` message.

Note: the player communicates its capacity to interrupt media playback with [[#simid-player-init]] message, parameter `variableDurationAllowed`. The creative must not post `requestPause` if the player sets `variableDurationAllowed` value to `false`. 

#### resolve #### {#simid-creative-requestPause-resolve}
The player replies to `Creative:requestPause` with a `resolve` if it paused the media.
#### reject #### {#simid-creative-requestPause-reject}
The player replies to `Creative:requestPause` with a `reject` if it did not pause the media or the playback is already paused.

### SIMID:Creative:requestPlay ### {#simid-creative-requestPlay}
The creative requests the player to resume media playback by posting a `SIMID:Creative:requestPlay` message.

Note: the player communicates its capacity to interrupt media playback with [[#simid-player-init]] message, parameter `variableDurationAllowed`. The creative must not post `requestPlay` if the player sets `variableDurationAllowed` value to `false`.


#### resolve #### {#simid-creative-requestPlay-resolve}
The player replies to `Creative:requestPlay` with a `resolve` if it resumed media playback.

#### reject #### {#simid-creative-requestPlay-reject}
The player replies to `Creative:requestPlay` with a `reject` if it did not resume the media or the playback is already in progress.

### SIMID:Creative:requestResize ### {#simid-creative-requestResize}

The creative requests ad resize by posting a `SIMID:Creative:requestResize` message.

The player must not resize the ad unless it can change the dimensions of both media element and SIMID iframe to the values specified by the `Creative:requestResize` message.

Note: the message `requestResize` must not be used to change screen mode. See the [[#simid-creative-requestFullScreen]] and [[#simid-creative-requestExitFullScreen]] messages.

<xmp class="idl">
dictionary MessageArgs {
	required Dimensions mediaDimensions;
	required Dimensions creativeDimensions;
};
dictionary Dimensions {
	required long x;
	required long y;
	required long width;
	required long height;
};

</xmp>
<dl dfn-type=attribute dfn-for=FooInterface class="idl highlight def">
	<dt><dfn>mediaDimensions</dfn>
	<dd>Media element size and coordinates.
	<dt><dfn>creativeDimensions</dfn>
	<dd>SIMID iframe size and coordinates.
</dl>

#### resolve #### {#simid-creative-requestResize-resolve}
The player replies to `requestResize` with a `resolve` if it has resized the ad and set the dimensions to the values specified by the `requestResize` message.

#### reject #### {#simid-creative-requestResize-reject}
The player responds to `requestResize` with `reject` when it ignores the message or is unable to complete the resizing. 


### SIMID:Creative:requestSkip ### {#simid-creative-requestSkip}

See <a href="#diagram-requestSkip">Diagram 13. `Creative:requestSkip` Sequence</a>.

The creative requests ad skip by posting a `SIMID:Creative:requestSkip` message. If feasible, in response to `requestSkip`, the player terminates the ad and goes through the [[#simid-player-adSkipped]] message sequence. 
 
Note: the SIMID interactive component implements skip related behavior and features (<button skip-ad>Skip Ad</button> button) only if the player delegates skippability to the creative - the value of [[#simid-player-init]] message `args.environmentData.skippableState` is `"adHandles"`. 


<div diagram id="diagram-requestSkip">
	<p>`Creative:requestSkip` Sequence</p>
	<img src="images/dgrm-requestSkip.png" alt="Creative:requestSkip sequence.">
	<ol dgrm-details>
		<li>Creative posts `Creative:requestSkip` message.</li>
		<li>Player hides the SIMID iframe.</li>
		<li>Player stops the ad media playback.</li>
		<li>Player responds with [[#simid-creative-requestSkip-resolve]].</li>
		<li>Player posts [[#simid-player-adSkipped]] message.</li>
		<li>Creative responds to `Player:adSkipped` with [[#simid-player-adSkipped-resolve]].</li>
		<li>Player unloads the SIMID iframe.</li>
	</ol>
</div>


#### resolve #### {#simid-creative-requestSkip-resolve}
If the player skips the ad, it responds with a `resolve`. The player then goes through its skip workflow (<a href="#diagram-requestSkip">diagram 13</a>, <span steps><b>5</b><b>6</b><b>7</b></span>). See [[#simid-player-adSkipped]].

#### reject #### {#simid-creative-requestSkip-reject}
The player replies with a `reject` if it cannot skip the ad. With the skip rejection:
	<ul collapse>
		<li>The media playback continues.</li>
		<li>The iframe remains visible.</li>
		<li>The player continues posting `SIMID:Media` and `SIMID:Player` messages to the SIMID iframe.</li>
		<li>The creative maintains two-way communication with the player; it waits for, and responds to, the player transmitting ad completion related messages.</li>
	</ul>

### SIMID:Creative:requestStop ### {#simid-creative-requestStop}

See <a href="#diagram-requestStop">Diagram 14. `Creative:requestStop` Sequence</a>.

The creative stops the ad by posting a `SIMID:Creative:requestStop` message. Typically, in the cases of the extended ad experiences, the user controls the ad end by interacting with the "Close Ad" button. Normally, media playback is complete by the time `requestStop` arrives.
If feasible, the player hides the iframe, stops media playback that is still in progress, and responds with a `resolve`.  

If feasible, the player hides the iframe, stops media playback that is still in progress, and responds with a [[#simid-creative-requestStop-resolve]] (<a href="#diagram-requestStop">diagram 14</a>, <span steps><b>2</b><b>3</b><b>4</b></span>). Subsequently, the player proceeds with the [[#simid-player-adStopped]] sequence (<a href="#diagram-requestStop">diagram 14</a>, <span steps><b>5</b><b>6</b><b>7</b></span>).

The SIMID interactive component engages ad stop functionality only if the player states its ability to vary ad duration. See [[#simid-player-init]], `Message.args.variableDurationAllowed` details. The interactive component logic must expect that the player will unload SIMID iframe immediately upon posting a `resolve` response under the SIMID-compliant circumstances.

In the event the interactive component disregards or fails to accommodate player’s ability to resolve `requestStop`, the iframe remains visible and the player continues sending `SIMID:Media` and `SIMID:Player` messages. The creative should maintain communication with the player. See [[#simid-creative-requestStop-reject]].


<div diagram id="diagram-requestStop">
	<p>`Creative:requestStop` Sequence</p>
	<img src="images/dgrm-requestStop.png" alt="Creative:requestStop sequence.">
	<ol dgrm-details>
		<li>Creative posts `Creative:requestStop` message.</li>
		<li>Player hides the SIMID iframe.</li>
		<li>Player stops the ad media playback.</li>
		<li>Player responds with [[#simid-creative-requestStop-resolve]].</li>
		<li>Player posts [[#simid-player-adStopped]] message.</li>
		<li>Creative responds to `Player:adStopped` with [[#simid-player-adStopped-resolve]].</li>
		<li>Player unloads the SIMID iframe.</li>
	</ol>
</div>

#### resolve #### {#simid-creative-requestStop-resolve}
If the player can stop the ad, it responds with a `resolve` (<a href="#diagram-requestStop">diagram 14</a>, <span steps><b>4</b></span>). The player then goes through [[#simid-player-adStopped]] workflow (<a href="#diagram-requestStop">diagram 14</a>, <span steps><b>5</b><b>6</b><b>7</b></span>).


#### reject #### {#simid-creative-requestStop-reject}
The player cannot stop the ad, it responds with a `reject`. With the requestStop rejection:
<ul collapse>
	<li>The media playback continues - if not previously ended;</li>
	<li>The iframe remains visible;</li>
	<li>The player continues posting messages to the iframe.</li>
</ul>

The creative keeps communication with the player open; it waits for, and responds to, the player transmitting ad completion related messages.


# Referencing a SIMID creative from VAST # {#api-vast}

When a SIMID creative is referenced within a VAST document, the `<InteractiveCreativeFile>` element must include
the following required attributes on the element: `type="text/html"` and `apiFramework="SIMID"`.

The value of the `apiFramework` attribute identifies SIMID as the required API for the creative. Players that do not support the SIMID API may load
an audio or video file included with the ad, but they will not load or play the SIMID creative.

Media players that do support the SIMID API should handle version negotiation between the creative and the media player via the
[[#api-ad-loading]] algorithm. The SIMID API version is not identified by any element or attribute in the VAST file.

A third, optional attribute which may be included on the InteractiveCreativeFile element is `variableDuration="true"`.
If present, this attribute indicates that the ad unit is only playable if
the media player allows the creative to pause playback of the ad's audio or video and extend the duration of the ad break (for example, with
interactive content such as a game or survey). If the player does not support or allow this capability, then it **must not** render
the current ad's audio/video or SIMID creative. The player should error out the ad instead (and either resume its primary content or continue
on to the next ad in the current ad pod).

# Common Workflows # {#common-workflows}

## How to Handle Ad Loading ## {#api-ad-loading}

The player must follow this workflow for loading an ad.

1. The player must create an iframe element for the SIMID creative. The player
	iframe should start out hidden. The iframe should be capable of executing
	javascript and loading resources.
2. The player starts listening on the window that is the parent of the iframe
	for messages from the creative.
3. The player sets the src element of the iframe to the url provided by
	the creative's VAST InteractiveCreativeFile element. The player should
	assume this will be a cross domain iframe.
4. The player waits until the creative inializes a session.
	[[#establish-session]] The player responds with a resolve message.
	The resolve message includes the correlator that must be present in
	all messages going forward.
5. The player then sends a [[#simid-player-init]] message with all relevant parameters.
	The player waits until the creative responds with resolve.  If the
	creative responds with reject, the player should immediately unload
	the creative's iframe.
6. Where possible the player should wait until both the creative has responded
	to the [[#simid-player-init]] and the video is ready to start playing. Ready
	to start playing means the first frame will show and playback will continue.
7. When the video is started the player sends a [[#simid-player-startCreative]] message.
	The player must overlay the creative iframe over the video element exactly.
	The player must make the creative visible. The creative should respond to
	this message immediately with [[#simid-player-startCreative-resolve]].

## How to Handle Ad Playback ## {#api-ad-playback}

The video player is responsible for handling playback of the video as well as
tracking video related events. The SIMID creative on the other hand handles
playback of interactive content and internal tracking related to interactivity
(custom events, creative impression if desired (recommended)).

### Ad Pause ### {#api-ad-pause}

If the {{EnvironmentData/variableDurationAllowed}} flag is set to `true` then
the player should enable video pause by the SIMID creative via the
SIMID:Creative:requestPause message. The player must respond to
SIMID:Creative:requestPause with the `AdPaused` event.

When the SIMID creative would like to resume video playback, it should send a
SIMID:Creative:requestPlay message. The player must
respond to SIMID:Creative:requestPlay message with resolve and play the video.

### Ad Resizing and Fullscreen ### {#api-resizing}


The player may resize the ad slot. The player must send a [[#simid-player-resize]] message any time the ad slot size is changed.

If {{EnvironmentData/fullscreenAllowed}} is `true`, the SIMID creative may
send a [[#simid-creative-requestFullScreen]] message. The player must resize only the ad
slot to fullscreen (not the video). The SIMID creative then will resize the
video as it sees fit. The player must send a [[#simid-player-resize]] message to the SIMID creative
with {{ResizeParameters/fullScreen}} set to `true` and {{ResizeParameters/videoDimensions}} and
{{ResizeParameters/creativeDimensions}} set to the full screen dimensions.

If player goes fullscreen on its own. Then the player must send a [[#simid-player-resize]] message to the SIMID creative
with {{ResizeParameters/fullScreen}} set to `true` and {{ResizeParameters/videoDimensions}} and
{{ResizeParameters/creativeDimensions}} set to the full screen dimensions.



## How to Handle Ad End and Unload ## {#api-end}

Following are cases where ad can end:
1. Ad was skipped, either by player or creative (if the ad contains
	the skip button). See [[#api-skip]].
2. The creative has fired [[#simid-creative-requestStop]] message and the player has allowed the ad to stop.
3. The player has fired [[#simid-player-adStopped]] message and the creative resolved.
4. Ad errors out. See [[#api-error]].

### Ad Skips ### {#api-skip}

**Skip Ad Handled by Player**
1. The player sends a [[#simid-player-adSkipped]] message to the ad.
2. The player hides the creative.
3. The creative may dispatch any tracking pixels via [[#simid-creative-reportTracking]]
3. The creative may wait for [[#simid-creative-reportTracking-resolve]]
	from the reportTracking message.
4. The creative dispatches `resolve` on the `adSkipped` message [[#simid-player-adSkipped-resolve]].
5. The player fires any skip tracking pixels.
6. The player unloads the ad.

**Skip Ad Handled by Ad**
1. The creative dispatches [[#simid-creative-requestSkip]].
2. The player dispatches resolves the to the `requestSkip` message.
3. The player follows all the steps in `Skip Ad Handled by Player`.

### Ad Ends Before Video Completion ### {#api-end-before-complete}

This scenario applies when the ad chooses to signal the player to kill it,
typically at the prompting of the viewer. A good example would be a survey that
allows the viewer to skip immediately to content when completed.
1. The ad cleans up and dispatches [[#simid-creative-requestStop]].
2. The player unloads the ad.

### Ad Extends Beyond Video Completion ### {#api-extend}

This scenario is only possible when the
{{EnvironmentData/variableDurationAllowed}} flag is set to `true`. Video
duration must only be extended in response to user interaction.
1. User interacts at any point during playback of the video, triggering extended
	ad portion.
2. The Creative dispatches [[#simid-creative-requestChangeAdDuration]] message with the new duration.
3. The ad enters its extended phase.
4. The creative dispatches [[#simid-creative-requestStop]] when extended phase is finished.

### Ad Completes at Video Completion ### {#api-complete}

When an ad finishes at the same time as its video.
1. The player sends a [[#simid-player-adStopped]] message to the ad.
2. The player hides the creative.
3. The creative may dispatch any tracking pixels via
	[[#simid-creative-reportTracking]]
4. The creative may wait for a [[#simid-creative-reportTracking-resolve]]
	response message from the reportTracking message.
5. The creative dispatches `resolve` on the `adSkipped` message [[#simid-player-adStopped-resolve]].
6. The player unloads the ad.

### Ad Errors Out ### {#api-error}

The SIMID creative or the player may terminate the ad unit with an error at any
time. If the SIMID creative indicates an error, the player should try to stop ad
unit playback. This might not be possible in server side stitched ads.

The player may error out if the ad does not respond with
[[#simid-player-init-resolve]] in a reasonable amount of time.

When an player errors out it must follow these steps.
1. The player sends a [[#simid-player-fatalError]] message to the ad.
2. The player hides the creative.
3. The creative may dispatch any tracking pixels via
	[[#simid-creative-reportTracking]]
4. The creative may wait for a [[#simid-creative-reportTracking-resolve]]
	response from the reportTracking message.
5. The creative dispatches `resolve` on the `adSkipped` message
	[[#simid-player-fatalError-resolve]].
6. The player unloads the ad.

### User Experience ### {#user-experience}

This specification does not define the user experience for a close control or other generic media interaction 
behavior by the ad creative or the media player. The publisher media player is in
full control over its user experience and can present its controls (or hide them) as needed.
The publisher media player may dismiss the ad creative at any point in time. The
ad creative can also request to be dismissed at any point in time. Some
implementations may have a publisher provided close control, as well as various other controls, and others may not.
An ad creative may opt to show its own controls, including a close control. Both ad creatives and
media players should ensure that consumers are presented with a good ad experience.

### Additional Notes ### {#api-notes}

The player may send a [[#simid-player-adStopped]] message at any time. The creative should respond with
`resolved` after finishing its ad end logic. The player should allow 1 second
between sending the [[#simid-player-adStopped]] message and receiving `resolved`. The implementer of the
player should take into consideration that dropping a SIMID ad unit before it has
dispatched `resolved` may result in tracking discrepancies, and that sending the
[[#simid-player-adStopped]] message before the ad experience has ended (which is AFTER the optional
lean-in phase) could harm the overall ad experience.

The SIMID creative may also dispatch [[#simid-creative-requestStop]] at any time, signaling to the
player that the ad has finished and unloaded. Any further interaction with the
SIMID creative after `requestStop` may not result in the desired outcome. The same
is true for `fatalError`.

# Error Handling and Timeouts # {#errors}

If the media cannot be played the player should terminate the ad and fire an error using the standard VAST errors.

If either the interactive ad or player wants to terminate with an error the player should fire a 902 error. In cases where this is not possible like live server side ad insertion the player should remove the ad overlay and continue tracking quartiles and completion.

The ad or player should pass a specific error code to indicate why it errored out. The ad can also hand back a string with extra details about the error.

# Messaging Protocol # {#msg-proto}

Messages sent using the standard postMessage API are processed asychronously. To facilitate asynchronous communication between the media player and the creative, SIMID employs a custom messaging protocol.

The protocol defines both the data structure of messages exchanged by both
parties and the algorithms needed to reliably handle the exchange of these
messages.

The protocol is designed to be easily implemented on top of the
{{Window/postMessage}} interface, available across the cross-domain <{iframe}> elements which are
used to isolate the SIMID creative from the media player.




## Transport Layer

A <dfn for="message">transport</dfn> is a communication mechanism that can send
[=serialized messages=] between two parties. In SIMID's case, those are the video
player and the creative.

A <dfn for="message">serialized message</dfn> is a text string that one of the
parties, the <dfn for="message">sender</dfn>, forwards to the other party, the
<dfn for="message">receiver</dfn>, through the [=message/transport=].

The [=message/transport=] must guarantee the following <dfn
for="message/transport">properties</dfn>:
- It must guarantee that both parties of the channel are unambiguously defined and that only those two parties observe any [=serialized messages=] sent by either of them.
- It must guarantee that all [=serialized messages=] eventually get delivered to the other party.
- It must guarantee that the [=serialized messages=] are delivered intact, without any modifications.
- It must guarantee that all [=serialized messages=] are delivered in the order that they were sent by the sender.

The [=message/transport=] is not required to deliver [=serialized messages=]
synchronously, but it must deliver them as soon as possible.

Note: This means that a [=message/sender=] can not assume that a message is
delivered to the [=message/receiver=] unless the [=message/receiver=] sends a
message back that acknowledges receipt. It also means that exceptions on the
[=message/receiver's=] side can't be caught by the [=message/sender=] unless
the [=message/receiver=] explicitly sends a message back to the
[=message/sender=] with the exception.

### {{Window/postMessage}} Transport

In SIMID the media player and creative use the standard postMessage API to communicate across the cross-origin <{iframe}> boundary.

### Message Serialization ### {###msg-serialization}

To <dfn for="message">serialize</dfn> a {{Message}} to a [=serialized message=],
apply `JSON.stringify` to the {{Message}} data structure. The resulting
{{DOMString}} represents the [=serialized message=].

To <dfn for="message">deserialize</dfn> a [=serialized message=] to a
{{Message}} data structure, apply `JSON.parse` to the [=serialized message=].
The resulting object has the {{Message}} data structure.

The [=message/sender=] should not transmit any [=serialized messages=] that
cannot be correctly [=message/deserialized=] by the [=message/receiver=].

The [=message/receiver=] should discard and ignore any [=serialized messages=]
that it cannot correctly [=message/deserialize=].


## Session Layer

Multiple <dfn for="message">sessions</dfn> may be active over a single
[=message/transport=] at any given time.

A [=message/session=] is uniquely identified by a <dfn for="message">session
identifier</dfn>. All messages belonging to a [=message/session=] *must*
reference the same [=message/session identifier=].

### Establishing a new session ### {#establish-session}

A [=message/session=] is established by running the [=establish a new session=]
algorithm.

<section algorithm="to establish a new session">

To <dfn for="message">establish a new session</dfn>, you *must* run the
following steps:

: Input
:: none
: Output
:: |sessionIdPromise|, a {{Promise}} that will resolve to a
   [=session identifier=]

1. Let |sessionId| be a new [=session identifier=].

Advisement: It is recommended to use a UUID for the [=message/session
identifier=].

2. Let |type| be `createSession`.
3. Let |args| be `undefined`.
4. Let |sessionIdPromise| be a new unresolved {{Promise}}.
5. Start the [=send an acknowledgement message=] algorithm with |sessionId|, |type| and
   |args|. Let |ackPromise| be the return value.
6. Return |sessionIdPromise|.
7. When |ackPromise| resolves:
   - If it is fulfilled, then resolve |sessionIdPromise| with |sessionId|.
   - If it is rejected with |error|, then reject |sessionIdPromise| with
     |error|.

</section>

### Sending messages

To send a message through a [=message/session=], run the [=send a message=]
algorithm.

<section algorithm="to send a message">

To <dfn for="message">send a message</dfn>, you *must* run the following
steps synchronously:

: Input
:: |sessionId|, a [=session identifier=]
:: |type|, a [=message type=]
:: |args|, an optional object to be submitted with the message
: Output
:: |messageId|, a [=message identifier=]

1. Let |messageId| be
   - `0`, if this is the first message in the [=message/session=] identified
     by |sessionId|.
   - |messageId| of the previous message sent on the [=message/session=]
     identified by |sessionId| incremented by `1`, otherwise.
2. Let |timestamp| be the current number of milliseconds since January 1, 1970, 00:00:00 UTC (`Epoch` time).
3. Let |message| be a new {{Message}} object with its attributes initialized
   to |sessionId|, |messageId|, |type|, |timestamp| and |args|.
4. Let |serializedMessage| be the result of running `JSON.stringify` on
   |message|.
5. Transmit |serializedMessage| to the other party through the
   [=message/transport=].
6. Return |messageId|.

</section>

While most messages can be sent "fire-and-forget", some require the sender to
be informed that they were properly received and handled by the receiver. The
protocol uses semantics similar to the {{Promise}} API for this.

<section algorithm="to send an acknowledgement message">

To <dfn for="message">send an acknowledgement message</dfn>, you *must* run the
following steps:

: Input
:: |sessionId|, a [=session identifier=]
:: |type|, a [=message type=]
:: |args|, an optional object to be submitted with the message
: Output
:: |promise|, a {{Promise}} which will eventually resolve to the value sent
   back by the other party

1. Run the [=send a message=] algorithm with |sessionId|, |type| and |args|.
   Let |messageId| be the return value.
2. Let |promise| be a new unresolved {{Promise}}.
3. Add |promise| to the [=resolve list=], annotated with |sessionId| and
   |messageId|.
4. Return |promise|.

</section>

### Receiving messages

To be able to detect new incoming [=message/sessions=] and receive messages from
existing sessions, every party should start running the [=handle incoming
messages=] algorithm as soon as possible.

<section algorithm="to handle an incoming message">

To <dfn for="message">handle an incoming message</dfn>, you *must* run the
following steps:

: Input
:: |serializedMessage|, a [=serialized message=] received from the
   [=message/transport=]
: Output
:: none

1. Let |message| be the result of running `JSON.parse` on
   |serializedMessage|.
   1. If `JSON.parse` threw an exception, ignore the exception and abort
      execution of this algorithm.
2. If |message|.{{Message/type}} is `resolve` or `reject`:
   1. Let |sessionId| be |message|.{{Message/sessionId}}.
   2. Let |messageId| be
      |message|.{{Message/args}}.{{ResolveMessageArgs/messageId}}.
   3. Let |promise| be the promise in the [=resolve list=] for |sessionId|
      and |messageId|, if any.
   4. If a |promise| was found:
      1. If |message|.{{Message/type}} is `resolve`, then fulfill |promise|
         with |message|.{{Message/args}}.{{ResolveMessageArgs/value}}.
      2. If |message|.{{Message/type}} is `reject`, then reject |promise| with
         |message|.{{Message/args}}.{{ResolveMessageArgs/value}}.
3. Otherwise: pass |message| to the user of the protocol for handling.

</section>

## Message Data Structure ## {##msg-struct}

A protocol message is represented by the {{Message}} data structure.

<xmp class="idl">
dictionary Message {
  required DOMString sessionId;
  required unsigned long messageId;
  required unsigned long timestamp;
  required DOMString type;
  any args;
};
</xmp>

A {{Message}} has an associated {{Message/sessionId}}, a string that uniquely
identifies the [=message/session=] to which the {{Message}} belongs.

A {{Message}} has an associated {{Message/messageId}}, an integer that
increments with each message sent by the sender over the [=message/session=]
specified by {{Message/sessionId}}.

Note: The combination of {{Message/sessionId}} and {{Message/messageId}}
uniquely identifies a single message. The combination of the values of these two
attributes may never occur twice.

A {{Message}} has {{Message/timestamp}} property. {{Message/timestamp}} is expressed in
a number of milliseconds since January 1, 1970, 00:00:00 UTC (`Epoch` time).
{{Message}} sender must set `timestamp` value as close as possible
to the moment the underlying process occurs. However, the `receiver` should not assume that `timestamp`
value reflects the exact instant {{Message}} triggering event chain was accomplished.

For example, if {{Message}} communicates ad video state change, media player sets {{Message/timestamp}} value to the moment the corresponding video event arrives from `HTMLVideoElement`.

A {{Message}} has an associated {{Message/type}}, a string that defines the type
of message that is being sent and informs the receiver how to interpret the
{{Message/args}} parameter.

A {{Message}} may have associated {{Message/args}}, which are
{{Message/type}}-specific additional arguments. The data structure and meaning
of {{Message/args}} is defined in the respective message type definitions.


### <dfn for="message">`resolve`</dfn> messages ### {###msg-proto-resolve}

{{Message/type}} must be `resolve`

{{Message/args}} must be a {{ResolveMessageArgs}} object:

<xmp class="idl">
dictionary ResolveMessageArgs {
  required unsigned long messageId;
  any value;
};
</xmp>

{{ResolveMessageArgs/messageId}} refers to the {{Message/messageId}} attribute
of the message that is being resolved.

{{ResolveMessageArgs/value}} may include a value associated with this `resolve`
message.

### <dfn for="message">`reject`</dfn> messages ### {###msg-proto-reject}

{{Message/type}} must be `reject`

{{Message/args}} must be a {{ResolveMessageArgs}} object.

{{ResolveMessageArgs/value}} may include an error message associated with this
`reject` message.

<xmp class="idl">
dictionary ResolveMessageArgsValue {
  unsigned long errorCode;
  DOMString message;
};
</xmp>


## Error Codes ## {#error-codes}
This table describes SIMID error codes the creative may fire.
<p table-header id="table-error-codes">Error Codes.</p>
<table class="alternatecolor">
  <tbody>
    <tr>
      <th>Error Code</th>
      <th>Error Type</th>
      <th>Description</th>
    </tr>
    <tr>
      <td>1100</td>
      <td>Unspecified error.</td>
      <td>Catchall error if the creative could not find a matching error code.
      The creative should be more specific in the error message.</td>
    </tr>
    <tr>
      <td>1101</td>
      <td>Resources could not be loaded.</td>
      <td>The SIMID creative tried to load resources but failed.</td>
    </tr>
    <tr>
      <td>1102</td>
      <td>Playback area not usable by creative.</td>
      <td>The dimensions the creative needed were not what it received.</td>
    </tr>
    <tr>
      <td>1103</td>
      <td>Wrong SIMID version.</td>
      <td>The creative could not support the players version.</td>
    </tr>
    <tr>
      <td>1104</td>
      <td>Creative not playable for a technical reason on this site.</td>
      <td></td>
    </tr>
    <tr>
      <td>1105</td>
      <td>Request for expand not honored.</td>
      <td>The creative requested to expand but the player did not allow it.</td>
    </tr>
    <tr>
      <td>1106</td>
      <td>Request for pause not honored.</td>
      <td>The creative requested pause but the player did not pause.</td>
    </tr>
    <tr>
      <td>1107</td>
      <td>Play mode not adequate for creative.</td>
      <td>The creative requires playback control but the player is not
          giving control. This error should only fire if the VAST for
          the ad specified that it needs playback control.</td>
    </tr>
    <tr>
      <td>1108</td>
      <td>Ad internal error.</td>
      <td>The creative had an error not related to any external dependencies.</td>
    </tr>
    <tr>
      <td>1109</td>
      <td>Device not supported.</td>
      <td>The creative could not play or render on the device.</td>
    </tr>
    <tr>
      <td>1110</td>
      <td>The player is not following the spec in the way it sends messages.</td>
      <td></td>
    </tr>
    <tr>
      <td>1111</td>
      <td>The player is not responding adequately to messages.</td>
      <td></td>
    </tr>
    <tr>
      <td>1200</td>
      <td>Unspecified error.</td>
      <td>Catchall error if the player could not find a matching error code.
		      The player should be more specific in the error message.</td>
    </tr>
    <tr>
      <td>1201</td>
      <td>Wrong SIMID version.</td>
      <td>The player could not support the creatives version.</td>
    </tr>
    <tr>
      <td>1202</td>
      <td>SIMID creative requesting more time than the player
          is willing to support.</td>
      <td></td>
    </tr>
    <tr>
      <td>1203</td>
      <td>SIMID creative requesting more functionality than the player is
          willing to support.</td>
      <td></td>
    </tr>
    <tr>
      <td>1204</td>
      <td>SIMID creative is doing actions not supported on this site.</td>
      <td></td>
    </tr>
    <tr>
      <td>1205</td>
      <td>SIMID creative is overloading the postmessage channel.</td>
      <td></td>
    </tr>
    <tr>
      <td>1206</td>
      <td>The SIMID creatives video could not be loaded.</td>
      <td></td>
    </tr>
    <tr>
      <td>1207</td>
      <td>Media Timeout.</td>
      <td>The video/audio media related to the SIMID creative buffered
          for too long and timed out.</td>
    </tr>
    <tr>
      <td>1208</td>
      <td>The SIMID creative is taking too long to resolve or reject messages.</td>
      <td></td>
    </tr>
    <tr>
      <td>1209</td>
      <td>The SIMID creatives media from the VAST response is not supported
          on this device.</td>
      <td></td>
    </tr>
    <tr>
      <td>1210</td>
      <td>The SIMID creative is not following the spec when initializing.</td>
      <td></td>
    </tr>
    <tr>
      <td>1211</td>
      <td>The SIMID creative is not following the spec in the way it
          sends messages.</td>
      <td></td>
    </tr>
  </tbody>
</table>

# Terminology # {#terminology}

: <dfn>SIMID VAST</dfn>
:: The VAST document that contains the SIMID ad unit components.

: <dfn>SIMID Ad Unit</dfn>
:: The SIMID ad video and the SIMID ad creative.

: <dfn>SIMID Video</dfn>
:: The SIMID ad video component if it's a progressively downloaded video file.

: <dfn>SIMID Video Stream</dfn>
:: The SIMID ad video component if it's SSAI video.

: <dfn>SIMID Live Video Stream</dfn>
:: The SIMID ad video component if live streaming video.

: <dfn>SIMID Creative</dfn>
:: The SIMID ad creative component (html doc and assets) that overlays the SIMID
	ad video.

: <dfn>SIMID Secondary Video</dfn>
:: Video assets that are loaded as part of the SIMID creative and not the
	primary video.

: <dfn>Content Video</dfn>
:: Any reference to video that is NOT a component or asset of the ad unit.
